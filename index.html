<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="GaoQ's blog" />





  <link rel="alternate" href="/atom.xml" title="GaoQ's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="There are no shortcuts to any place worth going">
<meta property="og:type" content="website">
<meta property="og:title" content="GaoQ&#39;s blog">
<meta property="og:url" content="http://gaoquan.wang/index.html">
<meta property="og:site_name" content="GaoQ&#39;s blog">
<meta property="og:description" content="There are no shortcuts to any place worth going">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GaoQ&#39;s blog">
<meta name="twitter:description" content="There are no shortcuts to any place worth going">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> GaoQ's blog - There are no shortcuts to any place worth going </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?b902fa08b28044c55da6c70921955ecb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>


<a href="https://github.com/GaoQ1"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/8b6b8ccc6da3aa5722903da7b58eb5ab1081adee/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_orange_ff7600.png"></a>


    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">GaoQ's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">There are no shortcuts to any place worth going</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            关于我
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/26/live-server和http-server/" itemprop="url">
                  live-server和http-server
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-26T11:04:05+08:00" content="2016-10-26">
              2016-10-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/教程/" itemprop="url" rel="index">
                    <span itemprop="name">教程</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/26/live-server和http-server/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/26/live-server和http-server/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>I find that the harder I work, the more luck I seem to have.</p>
</blockquote>
<h2 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h2><p>前端开发的过程中，总有这样的需求。想快速在移动端，PC端看看页面的效果，看看交互的效果。通常我们会自己搭建一个服务器，或简单或复杂。<br>这里推荐的两个live-server和http-server是基于nodejs的快速搭建服务器的插件。</p>
<h2 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h2><p>当然首先在用这两个live-server和http-server的前提是你要安装nodejs。<br>然后起个terminal窗口，全局安装live-server和http-server。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install -g live-server</div><div class="line">npm install -g http-server</div></pre></td></tr></table></figure></p>
<p>安装完毕后，你就可以在你需要其服务的目录下直接输入<code>live-server</code>或者<code>http-server</code></p>
<h2 id="live-server和http-server的区别"><a href="#live-server和http-server的区别" class="headerlink" title="live-server和http-server的区别"></a><a href="https://github.com/tapio/live-server" target="_blank" rel="external">live-server</a>和<a href="https://github.com/indexzero/http-server" target="_blank" rel="external">http-server</a>的区别</h2><p><code>live-server</code>提供的功能是：</p>
<ol>
<li>由于安全限制，AJAX的请求不能是<code>file://</code>的协议。因此你需要创建一个server来调用AJAX请求</li>
<li><code>live-server</code>另一个用途是，当所要监控的文件发生变化，页面会自动刷新，且十分方便简单。</li>
</ol>
<p><code>http-server</code>功能就略微单一，只是一个简单的无须配置的http服务器。</p>
<h2 id="live-server和http-server的命令行的使用"><a href="#live-server和http-server的命令行的使用" class="headerlink" title="live-server和http-server的命令行的使用"></a>live-server和http-server的命令行的使用</h2><p>关于live-server和http-server命令行的使用，比如如何设置port、host等等，具体的请查看对应的github进行查看。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/31/CSS_3D_Panorama/" itemprop="url">
                  CSS_3D_Panorama
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-31T10:37:01+08:00" content="2016-08-31">
              2016-08-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/转载笔记/" itemprop="url" rel="index">
                    <span itemprop="name">转载笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/31/CSS_3D_Panorama/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/31/CSS_3D_Panorama/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Tomorrow is never clear.Our time is here.</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>3D全景并不是什么新鲜事物了，但以前我们在Web上看到的3D全景一般是通过flash实现的。若我们能将CSS3 Transform的相关知识运用得当，也是能实现类似的效果。换句话说，3D全景其实就是CSS3 3D的应用场景之一。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>在实现CSS3 3D全景之前，我们先理清部分CSS3 Transform属性：</p>
<ul>
<li>Transform-origin: 元素变形的原点（默认值为 50% 50% 0，该数值和后续提及的百分比均默认基于元素自身的宽高算出具体数值）;</li>
<li>perspective: 指定了观察者与z=0平面的距离，使具有三维位置变换的元素产生透视效果（默认值：none，值只能是绝对长度，即负数是非法值）;</li>
<li>transform-style: 用于指定其为子元素提供2D还是3D的场景。另外，该属性是非继承的。</li>
<li>transform: 该属性能让你修改CSS可视化模型的坐标空间，其中包括平移(translate)、旋转(rotate)、缩放(scale)和扭曲(skew).</li>
</ul>
<p>下面对上述的一些点进行更深入的分析：</p>
<ul>
<li>perspective，该属性指定了“眼睛”与元素的<code>perspective-origin</code>(默认值为50% 50%)点的距离。那么问题来了：“当我们应用px作为衡量单位时，那它的实际距离该如何量化呢（即如何得到我们熟悉且易于表达的距离）?”  当我们的屏幕的分辨率是1080p(1920*1080px)，且该元素或祖先元素的perspective值为1920px时，该应用了CSS3 3D Transform的元素的立体效果就相当于我们我们在一个屏幕宽度(1920px)的屏幕前观看该元素的真是效果。尽管如此，目前我也不清楚如何准确地为元素设置一个合适的perspective的值，只能猜测个大概值，然后再动态修改值，以达到满意的呈现效果。<br><img src="/images/CSS3D/perspective.jpg" alt="呈现效果"><br>根据相似三角形的性质可计算出被前移的元素最终在屏幕上显示的实际大小</li>
</ul>
<p>另外，关于perspective还有另外一个重要的点。因为，<code>perspective-origin</code>的默认值为50% 50%,因此对哪个元素应用perspective属性，就决定了“眼睛”的位置(即我们的“眼睛”是在哪个角度看物体)。一般来说，当我们需要正视物体时，就会将该属性设置在与 <strong>该元素中心重合的某一祖先元素上</strong>。</p>
<p>再另外，如果说“如何让一个元素(背面)不可见?”，你可能会说backface-visibility:hidden。其实，对于在“眼睛”背后的元素(以元素的<code>transform-origin</code>为参考点)， <strong>即元素的z轴坐标值大于perspective的值，浏览器是不会将其渲染出来的</strong>。</p>
<ul>
<li>对于<code>transform-style</code>，该属性指定了其子元素是处于3D场景还是2D场景。对于2D场景，元素的前后位置是按照平时的渲染方式(即若在普通文档流中，是按照代码中元素的先后顺序，后面的元素会遮住在其前面的元素)；对于3D场景，元素的前后位置是按照真实世界的规则排序(即越靠近“眼睛”的，会遮住离“眼睛”更远的元素)。 另外，由于 <strong>transform-style属性是非继承性的，对于中间节点需要显示设定</strong></li>
<li>对于transform属性：下图整理了rotate3d、translate3d的变化方向：<br><img src="/images/CSS3D/transform.jpg" alt="变换方向"><br>transform中的变换属性的顺序是有关系的，如transformX(10px)rotate(30deg)与rotate(30deg)transformX(10px)是不等价的。</li>
</ul>
<p>另外，需要注意的是scale中如果有负数值，则该方向会产生180度的翻转。再另外，部分transform效果会导致元素(字体)模糊，如translate的数值存在小数、通过translateZ或scale方法元素等等。每个浏览器都有其不同的表现。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>上面理清了一些CSS Transform的知识点，下面就讲讲如何实现CSS 3D全景：</p>
<p>想象一下，当我们站在十字路口中间，身体不动，头部旋转 360°，这个过程中所看到的画面就形成了一幅以你为中心的全景图了。其实，当焦距不变时，我们就等同于站在一个圆柱体的中心。</p>
<p>但是，虚拟世界与现实的最大不同是：没有东西是连续的，即所有东西都是离散的。例如，你无法在屏幕上显示一个完美的圆。你只能以一个正多边形表示圆：边越多，圆就越“完美”。</p>
<p>同理，在三维空间，每个 3D 模型都等同于一个多面体（即 3D 模型只能由不弯曲的平面组成）。当我们讨论一个本身就是多面体（如立方体）的模型时并不足以为奇，但当我们想展示其它模型时，如球体时，就需要记住这个原理了。<br><img src="/images/CSS3D/ball.png" alt="球体模型"></p>
<p><a href="http://zwj360.im20.com.cn/" target="_blank" rel="external">淘宝造物节的活动页</a>就是CSS 3D全景的一个很赞的页面，它将全景图分隔成20等份，相邻的元素间差18deg(360/20)。需要注意的是：我们要确保每个元素的正面是指向圆柱中心的，所以要计算好每等份的旋转角度值。然后再将元素向外(即Z轴方向)平移r px.对于立方体r就是边长/2，而对于其他更复杂的正多面体呢？</p>
<p>举例：对于正九面体，每个元素的宽为210px，对应的角度为40deg，例如下图：<br><img src="/images/CSS3D/diagram.png" alt="正九面体的俯视图"><br><img src="/images/CSS3D/calc.png" alt="计算过程"></p>
<p>由此得到一个公用函数，只需传入含有元素的宽度和元素数量的对象，即可得到r值：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">calTranslateZ</span>(<span class="params">opts</span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.round(opts.width/(<span class="number">2</span>*<span class="built_in">Math</span>.tan(<span class="built_in">Math</span>.PI/opts.number)))</div><div class="line">&#125;</div><div class="line"></div><div class="line">calTranslateZ(&#123;</div><div class="line">  <span class="attr">width</span>: <span class="number">210</span>,</div><div class="line">  <span class="attr">number</span>: <span class="number">9</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p><img src="/images/CSS3D/expand4.gif" alt="俯视时所看到的元素外移动画"></p>
<p>另外，为了让下文易于理解，我们约定html结构是：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#view(perspective:1000px)</div><div class="line">  #stage(transform-style: perserve-3d)</div><div class="line">    #cube(transform-style: perserve-3d)</div><div class="line">      .div(width:600px;height:600px) /*组成立方体的元素*/</div></pre></td></tr></table></figure></p>
<p>正多面体构建完成后，就需要将我们的“眼睛”放置在正多面体内。由于在“眼睛”后的元素是不会被浏览器所渲染的（与 .div元素 是否设置 backface-visibility:hidden; 无关），且我们保证了.div元素的正面都指向了正多面体的中心，这就形成360deg被环绕的效果了。<br>那“眼睛”具体是被放置在哪个位置？<br>答：通过设置#stage元素的translateZ的值，让不能被看到的.div元素的Z轴坐标值大于perspective的值即可。如：立方体的正面的translateZ是-300px(为了保证立方体的正面是指向立方体中心，正面元素需要设置rotate(-180deg) translateZ(-300px), 即正面元素向“眼球”方向平移了300px),而#view的perspective的值为1000px，那么 #stage 的 translateZ 的值应该大于 700px 且小于 1300px，具体数值则取决于你想要呈现的效果了。</p>
<p>可由下图看出，将水平的 4 张图片合成后就是一张全景图：<br><img src="/images/CSS3D/panorama3d.jpg" alt="4张图合成的全景图"></p>
<p>理解上述知识后，就可以通过为元素设置合适的 CSS3 Transform 属性值，即可实现一张可交互的全景图了。当然，交互的效果可以是拖拽，也可以是重力感应等。</p>
<p>正如在上文提到的：“没有东西是连续的，即所有东西都是离散的…”。将《造物节》与后续全景图的水平方向上的图片分别合成一张图后，可以发现：图片数量越多，图片的要求也越低。你觉得呢？<br><img src="/images/CSS3D/zaowujie.jpg" alt="造物节全景图"></p>
<h2 id="全景图素材的制作"><a href="#全景图素材的制作" class="headerlink" title="全景图素材的制作"></a>全景图素材的制作</h2><p>将全景图制作分为设计类与实景类：</p>
<h3 id="设计类"><a href="#设计类" class="headerlink" title="设计类"></a>设计类</h3><p>要制作类似 <a href="http://zwj360.im20.com.cn/" target="_blank" rel="external">《淘宝造物节》</a> 的全景页面，设计稿需要有以下这些要求。</p>
<p>整体背景设计图如下（2580*1170px，被分成 20 等份）：<br><img src="/images/CSS3D/zaowujie.jpg" alt="造物节全景图"></p>
<p>基本要求：</p>
<ul>
<li>水平方向上需要首尾相连；</li>
<li>因为效果图最终需要切成 N 等份，所以尽可能让 设计图的宽度能被 N 整除；</li>
<li>图片尺寸不仅要考虑正视图的大小，还要考虑元素在旋转时依然能覆盖视野（可选）。</li>
</ul>
<p>当然，上图只是背景图，还可以添加一些小物体素材（通过运动速度的差异形成视差，增强立体效果），如：<br><img src="/images/CSS3D/item3.jpg" alt="小物体元素1"><br><img src="/images/CSS3D/item1.jpg" alt="小物体元素2"></p>
<p>小物体元素（虚线是用于参考的，造物节中共有 21 个小物体）</p>
<p>如上图所示，每个图片也是被等分成 M 等份。当然，M 取决于物体在背景上的具体位置和本身大小。<br>另外，M 的宽度是与 N 的宽度相等的。尽管部分物体（M&gt;1）的两侧等份的图案占比小，但建议保留同样的宽度。</p>
<p>注：如果小物体有特殊的变形效果，应该备注具体变形参数。</p>
<p>对于顶部和底图图片，则无特殊要求。</p>
<h3 id="实景类"><a href="#实景类" class="headerlink" title="实景类"></a>实景类</h3><p>如果想制作实景的全景，可以看看 Google 街景：<br><a href="https://www.google.com/streetview/publish/" target="_blank" rel="external">Google街景</a>推荐的设备如下：<br><img src="/images/CSS3D/panorama_machine.jpg" alt="实景类工具"></p>
<p>处理全景的方式：</p>
<ul>
<li>利用 RICOH THETA S 等专业设备拍出全景图</li>
<li>导出静态图像</li>
<li>利用设备专门提供的 APP 或 krpamo tools、pano2vr、Glsky box 等工具将静态图像转为6张图</li>
<li>利用 Web 技术制作可交互的全景图</li>
</ul>
<p>其中 Web 技术有以下3种可选方式（当然，还有其它）：</p>
<ul>
<li>CSS3（本文所提及的方式）</li>
<li>Three.js</li>
<li>krpano（为全景而生，低级浏览器则回退到 Flash），<a href="http://krpano.com/docu/tutorials/quickstart/?from=groupmessage&amp;isappinstalled=0#top" target="_blank" rel="external">查看教程</a></li>
</ul>
<p>可见，优秀硬件设备的出现，大大减少了后期处理的时间，而 Web 则提供了一个很好的展现平台。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>随着终端设备的软硬件不断完善和提高，Web 在 3D 领域也不甘落后，如果你玩腻了 2D 的 H5 或者想为用户提供更加新颖优秀的体验，全景也许是一种选择。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/28/如何运用最新的技术提升网页速度和性能/" itemprop="url">
                  如何运用最新的技术提升网页速度和性能
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-28T14:50:27+08:00" content="2016-08-28">
              2016-08-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/转载笔记/" itemprop="url" rel="index">
                    <span itemprop="name">转载笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/28/如何运用最新的技术提升网页速度和性能/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/28/如何运用最新的技术提升网页速度和性能/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>What doesn’t kill you makes you stronger.</p>
</blockquote>
<h2 id="性能设计"><a href="#性能设计" class="headerlink" title="性能设计"></a>性能设计</h2><p>在我们的项目中，我们每天都会和设计师和产品负责人讨论关于平衡美观和性能的问题。对于我们自己的网站，这样做是很简单的。简言之，我们认为好的用户体验从快速的内容传输开始，也就是意味着性能&gt;美观。</p>
<p>好的内容、布局、图片和交互是吸引用户的重要因素。这每个因素都会影响页面的加载时间和终端用户体验。每一步我们都在探讨如何在获得好的用户体验和保证设计美感的同时，最小化对性能的影响。</p>
<h2 id="内容优先"><a href="#内容优先" class="headerlink" title="内容优先"></a>内容优先</h2><p>我们想要把核心内容尽快呈现给用户，意味着我们要处理好基本的HTML和CSS。每个页面都应该达到基本的目的：传递信息。JS、CSS、网页字体、图片、网站分析等优化都是位居于核心内容之下的。</p>
<h2 id="可控性"><a href="#可控性" class="headerlink" title="可控性"></a>可控性</h2><p>给理想网站定义了标准后，我们总结出：想要达到预期效果，就要能对网站各方面的控制都游刃有余。我们选择构建自己的静态站点生成器，包括资源传输，并且由我们自己操控。</p>
<h2 id="静态站点生成器"><a href="#静态站点生成器" class="headerlink" title="静态站点生成器"></a>静态站点生成器</h2><p>我们用nodejs实现了静态站点生成器。它是采用带有简短JSON页面描述标签的Markdown文件来生成整个网站结构和它所有的资源。为了包括特殊的脚本页面，也可以附带一个HTML文件。以下是一个简单化的描述标签和markdown文件，用于博客的发布，用它来生成真正的HTML.</p>
<p>JSON描述标签：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">"keywords"</span>: [<span class="string">"performance"</span>, <span class="string">"critical rendering path"</span>, <span class="string">"static site"</span>],</div><div class="line"><span class="string">"publishDate"</span>: <span class="string">"2016-08-28"</span>,</div><div class="line"><span class="string">"authors"</span>: [<span class="string">"Co"</span>]</div></pre></td></tr></table></figure></p>
<p>markdown文件：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Title</div><div class="line">## Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</div></pre></td></tr></table></figure></p>
<h2 id="图片传输"><a href="#图片传输" class="headerlink" title="图片传输"></a>图片传输</h2><p>平均一个2406kb的网页中1535kb是图片。就因为图片在网站中占据了这么大一个比例，所以它也是性能优化的重点之一。</p>
<h2 id="Webp格式"><a href="#Webp格式" class="headerlink" title="Webp格式"></a>Webp格式</h2><p>Webp是一种现在图片格式，为网页图片提供了出色的低损耗、有损压缩。Webp格式的图片实质上比其他格式的小，有时可以比同样的JPEG图片小25%。Webp被大多数人所忽略，也没有被经常使用。截止到写这篇文章的时候，Webp仅支持Chrome、Opera和Android(仍超过我们50%的用户)，但我们可以优雅降级为JPG/PNG。</p>
<p>使用<picture>元素我们可以把图片从Webp优雅地降级到其他被广发支持的图片格式，如JPEG：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;picture&gt;</div><div class="line">  &lt;source type="image/webp" srcset="image-1.webp" media="(min-width: 640px)"&gt;</div><div class="line">  &lt;source type="image/webp" srcset="image-m.webp" media="(min-width: 320px)"&gt;</div><div class="line">  &lt;source type="image/webp" srcset="image-s.webp"&gt;</div><div class="line">  &lt;source srcset="image-1.jpg" media="(min-width: 640px)"&gt;</div><div class="line">  &lt;source srcset="image-m.jpg" media="(min-width: 320px)"&gt;</div><div class="line">  &lt;source srcset="image-s.jpg"&gt;</div><div class="line">  &lt;img alt="Description of the image" src="image-1.jpg"&gt;</div><div class="line">&lt;/picture&gt;</div></pre></td></tr></table></figure></picture></p>
<p>我们使用Scott Jehl 的picturefill来使那些不支持<picture>元素的浏览器获得支持，在各个浏览器中达到一致的效果。</picture></p>
<p>我们使用<img>作为那些不支持<picture>或者JS的浏览器的后备元素。使用图片的最大实例确保了它在后备方案中的可行性。</picture></p>
<h2 id="生成"><a href="#生成" class="headerlink" title="生成"></a>生成</h2><p>尽管图片传输方式已经确定了，我们仍需要思考怎样有效执行。我喜欢<picture>元素的功能，但不喜欢上面那些代码段，尤其是写内容是必须把它加进去。我们不想做这么费力的事情：每张图片都要写6个实例，所以优化这些图片并且把它们写在markdown文件的<picture>里面。所以：</picture></picture></p>
<h2 id="生成图片"><a href="#生成图片" class="headerlink" title="生成图片"></a>生成图片</h2><p>在构建过程中，原图片的多个实例，包括JPG、PNG和Webp格式，我们使用gulp responsive来生成。</p>
<h2 id="最小化图片"><a href="#最小化图片" class="headerlink" title="最小化图片"></a>最小化图片</h2><p>在markdown文件中写图片描述(image.jpg).</p>
<p>在构建过程中使用自定义markdown渲染器来为已经完全成熟的<picture>元素编译传统的markdown图片声明。</picture></p>
<h2 id="SVG动画"><a href="#SVG动画" class="headerlink" title="SVG动画"></a>SVG动画</h2><p>我们为自己的网站选择了特定的图表类型，其中SVG插图占了主要地位。这样做有以下几个原因：首先，SVG的图片比位图更小；其二，SVG图片本身就是响应式的，有很棒的伸缩性，所以不需要图片生成及<picture>元素；最后一点也是很重要的一点，就是我们可以通过CSS来不断改变它，赋予它新的活力！我们所有的组合页面都有一个自定义的动态SVG图，可以被概述页面所复用。这张图片作为我们所有的组合页面中的一种循环风格，使得页面设计一体化，同时又几乎不会对性能造成影响。请看这张动画，看看我们是如何用CSS来改变它的。<br><img src="/images/SEO/0.gif" alt="例子"></picture></p>
<h2 id="自定义网页字体"><a href="#自定义网页字体" class="headerlink" title="自定义网页字体"></a>自定义网页字体</h2><p>在深入之前，这里有一个关于在浏览器设置自定义字体的简短介绍。当浏览器发现CSS里面有@font-face的定义，但是用户的电脑并不支持该字体时，它会尝试下载该字体文件。在下载时，多数浏览器根本不会用这种字体来展示文本。这种现象称为“不可见文本的闪现”或者FOIT.如果你有留意，你会发现网页上都有这种情况存在。如果你问我，我会告诉你这会影响用户体验。它延迟了用户读取他们所需内容的时间。我们可以迫使浏览器改变这种行为，变成“无样式内容闪现”或者称为FOUT。我们告诉浏览器先使用普通字体，想Arial或者Georgia。当自定义的字体下载完成后，再代替标准字体并且重新渲染。这样，即使自定义字体只是一种优化。尽管没有自定义字体，网页看起来也完好，也能百分百的正常运行。勾选/不勾选复选框来切换我们的网页字体，来自己体验一下：<br>切换下载的字体类使用自定义网页字体可以改善我们的用户体验，只要你能够优化他们，并且负责任地为之服务。</p>
<h2 id="字型子集设定"><a href="#字型子集设定" class="headerlink" title="字型子集设定"></a>字型子集设定</h2><p>到目前为止，子集设定以最短的时间在改善网页字体性能方面取胜。我将会向每个使用自定义字体的网页开发者推荐子集设定。如果你能完全控制网页内容，并且知道它将要展示哪些特性的话，你可以完全使用子集设定。但是，即使是仅仅把字体设为西方语言，也会对文件大小造成很大的影响。例如，我们的Noto Regular WOFF 字体，默认是246KB，将其设为西方语言后，大小下降到31KB。我们使用Font squirrel webfont，这种字体真的很易用。</p>
<h2 id="字体监听器"><a href="#字体监听器" class="headerlink" title="字体监听器"></a>字体监听器</h2><p>Bram Stein推出的字体监听器是一个很了不起的脚本，可以帮助检查字体是否已被加载。至于你是如何加载字体的，是通过一个网页字体服务，还是自己上传就不可知了。在这个监听器告诉我们所有自定义的字体已经下载完毕后，我们就可以在<html>元素上添加一个字体加载完毕的类，我们的页面就会重新用心的字体：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">html</span>&#123;</div><div class="line">  <span class="attribute">font-family</span>: Georgia, serif;</div><div class="line">&#125;</div><div class="line"><span class="selector-tag">html</span><span class="selector-class">.fonts-loaded</span>&#123;</div><div class="line">  <span class="attribute">font-family</span>: Noto, Georgia, serif;</div><div class="line">&#125;</div></pre></td></tr></table></figure></html></p>
<p>注意：为了简短，我们有给上面的CSS中的Noto加上@font-face的声明。</p>
<p>我们可以设定一个cookie来记住所有的字体已经被加载过，就可以让他们缓存在浏览器里面了。我们使用这个cookie来替代重复的视图，这个我后续会解释。</p>
<p>在不久的将来，我们或许不需要Bram Stein的脚本来监听这个行为。CSS开发团队已经提案一个新的@font-face描述器，也叫font-display。它的属性值控制着一个可下载的字体是如何在还没加载出来时就渲染页面的。这是CSS对font-display的描述：它将带给我们像上面方法一样的行为效果。你可以读读更多关于font-display的属性。</p>
<h2 id="JS和CSS懒加载"><a href="#JS和CSS懒加载" class="headerlink" title="JS和CSS懒加载"></a>JS和CSS懒加载</h2><p>一般来讲，我们都是尽可能快的加载需要的资源。我们移除一些堵塞的请求来加快页面渲染，优化首屏，用浏览器缓存来处理重复的页面。</p>
<h3 id="JS懒加载"><a href="#JS懒加载" class="headerlink" title="JS懒加载"></a>JS懒加载</h3><p>设计上，我们的网站并没有很多JS。我们发展了一个javascript工作流来处理我们目前已有的js，以及未来会用到的js资源。</p>
<p>JS在<head>块里面渲染，这是我们想要的。JS应该只是用来提高用户体验，不应该是访问者需要的关键。处理JS堵塞渲染的简单方法就是把脚本放在页面的尾部。这样网页就会在真个HTML渲染完毕后才去加载JS。</head></p>
<p>另一种可以把脚本放在head执行的方案就是在<code>&lt;script&gt;</code>标签里面添加defer属性，来延迟脚本的执行。由于浏览器下载脚本是很快的，不会堵塞页面渲染进程，等到页面完全加载完，才会执行脚本里面的代码。还有一件事，我们没有使用像jQuery这些库，所以我们的脚本取决于vanilla脚本的特性。我们只是想要在浏览器加载脚本来支持这些特性。最终的结果就像下面的代码这样：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line"><span class="keyword">if</span>(<span class="string">'querySelector'</span> <span class="keyword">in</span> <span class="built_in">document</span> &amp;&amp; <span class="string">'addEventListener'</span> <span class="keyword">in</span> <span class="built_in">window</span>)&#123;</div><div class="line">  <span class="built_in">document</span>.write(<span class="string">'&lt;script src="index.js" defer&gt;&lt;/script&gt;'</span>);</div><div class="line">&#125;</div><div class="line">&lt;<span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure></p>
<p>我们把这小段脚本放在页面头部，来检测浏览器是否支持vanilla javascript的document.querySelector和window.addEventListener属性。如果支持，我们通过<code>&lt;script&gt;</code>标签直接给页面加载脚本，并使用defer属性让它不会堵塞页面渲染。</p>
<h3 id="懒加载CSS"><a href="#懒加载CSS" class="headerlink" title="懒加载CSS"></a>懒加载CSS</h3><p>对于首屏来讲，网站最大的渲染堵塞资源就是CSS了。只有当<code>&lt;head&gt;</code>里面的CSS文件完全加载完毕时，浏览器才会开始渲染页面。这种做法是经过深思熟虑的，若不是这样，浏览器就需要在整个渲染过程中不断重新计算布局尺寸，不断重绘。</p>
<p>为了防止CSS堵塞渲染，我们就需要异步加载CSS文件。我们使用了Filament Group的awesome loadCSS函数。该函数提供了一个回调，当CSS文件加载完后，我们设置一个cookie来声明CSS文件已经加载了。我们使用这个cookie来重现页面，这一点我后续会解释到。</p>
<p>CSS异步加载也带来这样一个问题，尽管HTML真的很快被渲染出来，但看起来只有纯粹的HTML，只有等到这个CSS文件加载完且停止时，才会有样式。这时就要提到关键CSS了。</p>
<h3 id="关键部分CSS"><a href="#关键部分CSS" class="headerlink" title="关键部分CSS"></a>关键部分CSS</h3><p>关键部分CSS可以这样来理解：它就是阻塞浏览器渲染出用户可识别的网页的一小部分CSS。我们注意网页的上半版版面。很明显，两个设备的版面的位置有很大的区别。因此我们做了一个大胆的猜测。</p>
<p>手动地检测这部分关键性的CSS是个很耗时的过程，尤其是样式、特性等不断改变时。这里有几个好的脚本，可以在你构建网页时，生成关键CSS。我们采用了Addy Osmani的版本。</p>
<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><p>我们自己部署de Voorhoede网站，因为我们希望能够控制服务器环境。我们也想要尝试，是否可以通过改变服务器的配置来大大提升性能。当前我们使用了Apache服务和HTTPS协议。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>为了提升性能和安全性，我们研究了如何配置服务端。</p>
<p>我们使用H5BP apache样板配置，这个对改善Apache网络服务的性能和安全性是个很好的开始。他们也有其他服务器环境的配置。对于我们的大部分 HTML、CSS 和 JS，我们使用GZIP压缩。对于我们的所有网站资源，都使用缓存HTTP标头的做法。请阅读下面关于缓存的章节。</p>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>用HTTPS来服务你的网站会对性能造成影响。这主要是设置了SSL握手，引入了大量潜在的东西。但通常情况下，我们可以做一些改变！</p>
<p>HTTP Strict Transport Security是一个HTTP标头，可以让服务器告诉浏览器只能用HTTPS来与它交互。这种方式防止HTTP请求被重定向为HTTPS。所有尝试用HTTP来访问站点的请求都会被自动转换成HTTPS。它可以来回的服务我们的网站。</p>
<p>TLS false start允许客户端在第一个TLS回合结束后，马上开始向后端发送加密的数据。这种优化为给一个回合新建一个TLS连接减少了握手。一旦客户端知道了密钥，就可以开始传输应用数据。剩下的握手用来确认是否有人篡改握手记录，并且可以并行处理。</p>
<p>TLS session resumption通过确认浏览器和服务器是否已经通过TLS取得联系来帮我们节省另一个来回。浏览器会记住这一次的标识符，下次发起连接时，这个标识符就会被重用，节省了一个来回。</p>
<h2 id="cookies的使用"><a href="#cookies的使用" class="headerlink" title="cookies的使用"></a>cookies的使用</h2><p>我们没有用一门服务端的语言，只有静态的Apache网络服务。但一个Apache网络服务仍可以做包括SSI在内的后端服务，并且读取cookies。通过巧用cookies和运行那部分被Apache改写的HTML，我们可以大大提升前端性能。下面这个例子就是。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;!-- #if expr="($HTTP_COOKIE!=/css-loaded/) || ($HTTP_COOKIE=/.css-loaded=([^;]+);?.*/&amp;&amp; $&#123;1&#125; != 0d82f.css)" --&gt;</div><div class="line">&lt;noscript&gt;&lt;link rel="stylesheet" href="0d82f.css"&gt;&lt;/noscript&gt;</div><div class="line">&lt;script&gt;</div><div class="line">  (function()&#123;</div><div class="line">    function loadCSS(url)&#123;&#125;</div><div class="line">    function onloadCss(stylesheet,callback)&#123;&#125;</div><div class="line">    function setCookie(name, value, expInDays)&#123;&#125;</div><div class="line"></div><div class="line">    var stylesheet = loadCSS('0d82f.css');</div><div class="line">    onloadCss(stylesheet, function()&#123;</div><div class="line">      setCookie('css-loaded', '0d82f', 100);</div><div class="line">    &#125;)</div><div class="line">  &#125;)()</div><div class="line">&lt;/script&gt;</div><div class="line"></div><div class="line">&lt;style&gt;/*critical CSS here*/&lt;/styles&gt;</div><div class="line"></div><div class="line">&lt;link rel="stylesheet" href="0d82f.css"&gt;</div></pre></td></tr></table></figure></p>
<p>The Apache server side logic are the comment looking lines starting with Apache 服务端逻辑是一些看起来一行一行的评论，一般这样开始：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;!-- #. Let&apos;s look at this step by step: $HTTP_COOKIE!=/css-loaded/ checks if no CSS cache cookie exists yet. $HTTP_COOKIE=/.css-loaded=([^;]+);?./ &amp;&amp; $&#123;1&#125; != &apos;0d82f.css&apos; checks if the cached CSS version is not the current version.</div></pre></td></tr></table></figure></p>
<p>If <!-- #if expr="..." --> 如果是true的话，我们就假定这是用户的第一次浏览。</p>
<p>第一次浏览我们添加了 <noscript> 标签，里面放置了 <link rel="stylesheet">。之所以这样做，是因为我们要异步加载整份CSS和JS。如果JS不能用的话，这种做法是不能执行的。这意味着，我们要用常规的加载CSS的方法来做回退。</noscript></p>
<p>我们添加了一个行内的脚本来懒加载CSS，onloadCSS 回调里面可以设置cookies.</p>
<p>在同一份脚本里面，我们异步加载了整份CSS。</p>
<p>在 onloadCSS的回调里面，我们用版本号来设置cookie的值。</p>
<p>在这个脚本后面，我们添加了一行关键CSS的样式。这个会阻塞渲染，但时间是非常短的，而且可以避免页面展示出来只有纯粹的HTML而没有样式的情况。</p>
<p><!-- #else --> 声明（意味着 css-loaded 的cookie 已经存在）用户重复浏览。因为我们可以从某种程度上来假定，CSS文件之前已经被加载过了，我们可以利用浏览器缓存来提供样式表。这样从缓存里面加载速度就很快了。同样的方法也被用来在第一次异步加载字体，后续的重复浏览也是从缓存里面获取字体。</p>
<h2 id="文件级缓存"><a href="#文件级缓存" class="headerlink" title="文件级缓存"></a>文件级缓存</h2><p>由于我们在重现页面时很大程度上依赖于浏览器缓存，所以我们需要确认我们的缓存是否合理。理想中我们是要永远的存储资源（CSS、js、 字体、图片），只有当这些文件被修改时才需要更新。当请求的URL是唯一时，缓存就会失效。每更新一个版本，我们都会用 git tag 打个标签。所以最简单的方式就是给我们请求的URL加上一个参数（代码版本号），如 <a href="https://www.voorhoede.nl/assets/css/main-8af99277a6.css?v=1.0.4.。" target="_blank" rel="external">https://www.voorhoede.nl/assets/css/main-8af99277a6.css?v=1.0.4.。</a></p>
<p>但是，这种做法的缺点就是当我们要写一个新的博客post（这也是我们代码库的一部分，并没有永久地存储在CMS），原来缓存的资源将会失效，尽管没有改变原来那些资源。</p>
<p>就在我们尝试去改善这种方法时，我们发现了 gulp-rev 和 gulp-rev-replace 。这些脚本会自动合理地在我们的文件名称后面添加一窜hash值。这意味着只有实际上文件被改变时，才会去改变请求的URL，这样每个文件的缓存就会自动失效。</p>
<h2 id="成果"><a href="#成果" class="headerlink" title="成果"></a>成果</h2><p>如果你看到这里，你应该是想要知道成果的。测试网页的性能可以采用像 PageSpeed Insights 这样的工具，它有很实用的提示。也可以使用 WebPagetest来测试，有扩展性的网络分析。我认为测试网页渲染性能的最好方法就是在疯狂地遏制网络通信时来观察网页的进程。这意味着，用一种不切实际的方法来遏制通信。在谷歌浏览器，你可以这样操作 (via the inspector &gt; Network tab) 来限制通信，观察网页形成过程中，请求是如何缓慢加载的。</p>
<p>下面是我们的网页在 50KB/s 的情况下的加载状况。<br>这是 de Voorhoede site 首屏的网络分析，是网页第一次进程的一个概览。</p>
<p>注意到在50KB/s的网速中，我们是如何让首屏的渲染只用了 2.27 秒的。也就是第一张幻灯片和瀑布图里面的黄色线所代表的位置。黄线恰好绘在就是HTML已经加载完的时间位置。HTML包含了关键CSS，保证页面的可观性。所有其他的CSS都是用懒加载，所以我们可以等到全部资源加载完时才与页面进行交互。这也是我们想要的效果！</p>
<p>另一个值得注意的就是自定义字体从来不在这缓慢的链接上加载。 font face 观察器会自动注意到这一点。但是，如果我们不异步加载字体，你注视大多数浏览器，都会出现 FOIT(不可见文本的闪现，上文有提及)的情况。</p>
<p>所有的CSS文件仅在8s后就都加载完毕。相反，如果我们不采用加载关键CSS的方式，而是采用加载全部CSS，我们在前8秒看到的将会是空白的页面。</p>
<p>如果你感到好奇，想与那些不太注重性能的网站对比一下加载时间，那赶紧试试吧。那个时间肯定是飞涨啊！</p>
<p>用上面介绍的工具测试了我们的网站，结果也是让人满意的。 PageSpeed insights 在移动性能方面给了我们100分，多么了不起啊！</p>
<p>PageSpeed insights 对 voorhoede.nl的测试结果! 速度100分！g</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/18/JavaScript设计模式二/" itemprop="url">
                  JavaScript设计模式二
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-18T14:06:04+08:00" content="2016-08-18">
              2016-08-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/18/JavaScript设计模式二/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/18/JavaScript设计模式二/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Comedy is acting out optimism.</p>
</blockquote>
<h2 id="中介者模式"><a href="#中介者模式" class="headerlink" title="中介者模式"></a>中介者模式</h2><p>字典中中介者的定义是，一个中立方，在谈判和冲突解决过程中起辅助作用。在我们的世界，一个中介者是一个行为设计模式，使我们可以导出统一的接口，这样系统不同部分就可以彼此通信。</p>
<p>如果系统组件之间存在大量的直接关系，就可能是时候，使用一个中心的控制点，来让不同的组件通过它来通信。中介者通过将组件之间显示的直接的引用替换成通过中心点来交互的方式，做到松耦合。这样可以帮助我们解耦和改善组件的重用性。</p>
<p>在现实世界中，类似的系统就是，飞行控制系统。一个航站塔(中介者)处理哪个飞机可以起飞，哪个可以着陆，因为所有的通信(监听的通知或者广播的通知)都是飞机和控制塔之间进行的，而不是飞机和飞机之间进行的额。一个中央集权的控制中心是这个系统成功的关键，也正是中介者在软件设计领域中所扮演的角色。</p>
<p>从实现角度来讲，中介者模式是观察者模式中的共享被观察者对象。在这个系统中的对象之间直接的发布/订阅关系被牺牲掉了，取而代之的是维护一个通信的中心节点。</p>
<p>也可以认为是一种补充-用于应用级别的通知，例如不同子系统之间的通信，子系统本身很复杂，可能需要使用发布/订阅模式来做内部之间的解耦。</p>
<p>另外一个类似的例子是DOM的事件冒泡机制，以及事件代理机制。如果系统中所有的订阅者都是对文档订阅，而不是对独立的节点订阅，那么文档就充当一个中介者的角色。DOM的这种做法，不是将事件绑定到独立节点上，而是用一个更高级别的对象负责通知订阅者关于交互事件的信息。</p>
<h3 id="基础的实现"><a href="#基础的实现" class="headerlink" title="基础的实现"></a>基础的实现</h3><p>中介者模式的一种简单的实现可以在下面找到，publish()和subscribe()犯法都被暴露出来使用：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mediator = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// Storage for topics that can be broadcast or listened to</span></div><div class="line">  <span class="keyword">var</span> topics = &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="comment">// Subscribe to a topic, supply a callback to be executed</span></div><div class="line">  <span class="comment">// when that topic is broadcast to</span></div><div class="line">  <span class="keyword">var</span> subscribe = <span class="function"><span class="keyword">function</span>(<span class="params"> topic, fn </span>)</span>&#123;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> ( !topics[topic] )&#123;</div><div class="line">        topics[topic] = [];</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      topics[topic].push( &#123; <span class="attr">context</span>: <span class="keyword">this</span>, <span class="attr">callback</span>: fn &#125; );</div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// Publish/broadcast an event to the rest of the application</span></div><div class="line">  <span class="keyword">var</span> publish = <span class="function"><span class="keyword">function</span>(<span class="params"> topic </span>)</span>&#123;</div><div class="line"></div><div class="line">      <span class="keyword">var</span> args;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> ( !topics[topic] )&#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      args = <span class="built_in">Array</span>.prototype.slice.call( <span class="built_in">arguments</span>, <span class="number">1</span> );</div><div class="line">      <span class="keyword">for</span> ( <span class="keyword">var</span> i = <span class="number">0</span>, l = topics[topic].length; i &lt; l; i++ ) &#123;</div><div class="line"></div><div class="line">          <span class="keyword">var</span> subscription = topics[topic][i];</div><div class="line">          subscription.callback.apply( subscription.context, args );</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">publish</span>: publish,</div><div class="line">      <span class="attr">subscribe</span>: subscribe,</div><div class="line">      <span class="attr">installTo</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> obj </span>)</span>&#123;</div><div class="line">          obj.subscribe = subscribe;</div><div class="line">          obj.publish = publish;</div><div class="line">      &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;());</div></pre></td></tr></table></figure></p>
<h3 id="高级的实现"><a href="#高级的实现" class="headerlink" title="高级的实现"></a>高级的实现</h3><p>更高级的实现方式，首先，让我们实现认购的概念，我们可以考虑一个中介者主题的注册。<br>通过生成对象实体，我们稍后能够简单的更新认购，而不需要去取消注册然后重新注册它们。认购可以写成一个使用被称作一个选项对象或者一个上下文环境的函数。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Pass in a context to attach our Mediator to.</span></div><div class="line"><span class="comment">//By default this will be the window object</span></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">root</span>)</span>&#123;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">guidGenerator</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="comment">//Our Subscriber constructor</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Subscriber</span>(<span class="params">fn, options, context</span>)</span>&#123;</div><div class="line">      <span class="keyword">if</span>(!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Subscriber))&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Subscriber(fn, context, options);</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//guidGenerator() is a function that generates</span></div><div class="line">        <span class="comment">//GUIDs for instances of our Mediators Subscribers so we can easily reference them later on. We're going to skip its implementation for brevity</span></div><div class="line"></div><div class="line">        <span class="keyword">this</span>.id = guidGenerator();</div><div class="line">        <span class="keyword">this</span>.fn = fn;</div><div class="line">        <span class="keyword">this</span>.options = options;</div><div class="line">        <span class="keyword">this</span>.context = context;</div><div class="line">        <span class="keyword">this</span>.topic = <span class="literal">null</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure></p>
<p>在我们的中介者模式中包含了一长串的回调和子主题，当中间人发布在我们中间人实体上被调用的时候被启动。它也包含操作数据列表方法。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Let's model the topic</span></div><div class="line"><span class="comment">//JavaScript lets us use a Function object as a conjunction of a prototype for use with the new object and a constructor function to be invoked.</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Topic</span>(<span class="params">namespace</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Topic))&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Topic(namespace);</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    <span class="keyword">this</span>.namespace = namespace || <span class="string">""</span>;</div><div class="line">    <span class="keyword">this</span>._callbacks = [];</div><div class="line">    <span class="keyword">this</span>._topics = [];</div><div class="line">    <span class="keyword">this</span>.stopped = <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Define the prototype for our topic, including ways to add new subscribers or retrieve existing ones.</span></div><div class="line">Topic.prototype = &#123;</div><div class="line">  <span class="comment">//Add a new subscriber</span></div><div class="line">  AddSubscriber: <span class="function"><span class="keyword">function</span>(<span class="params">fn,options,context</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> callback = <span class="keyword">new</span> Subscriber(fn, options, context);</div><div class="line">    <span class="keyword">this</span>._callbacks.push(callback);</div><div class="line">    callback.topic = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">return</span> callback;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们的主题实体被当做中间人调用的一个参数被传递。使用一个方便实用的calledStopPropagation()方法，回调就可以进一步被传播开来：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">StopPropagation: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.stopped: <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们也能够使得当提供一个GUID的标识符的时候检索订购用户更加容易:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">GetSubscriber: <span class="function"><span class="keyword">function</span>(<span class="params">identifier</span>)</span>&#123;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> x=<span class="number">0</span>,y=<span class="keyword">this</span>._callbacks.length; x&lt;y ; x++)&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>._callbacks[x].id == identifier || <span class="keyword">this</span>._callbacks[x].fn == identifier)&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>._callbacks[x];</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> z <span class="keyword">in</span> <span class="keyword">this</span>._topics)&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>._topics.hasOwnProperty(z))&#123;</div><div class="line">      <span class="keyword">var</span> sub = <span class="keyword">this</span>._topics[z].GetSubscriber(identifier);</div><div class="line">      <span class="keyword">if</span>(sub !== <span class="literal">undefined</span>)(</div><div class="line">        <span class="keyword">return</span> sub;</div><div class="line">      )</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着，在我们需要它们的情况下，我们也能够提供添加新主题，检查现有的主题或者检索主题的简单方法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">AddTopic: <span class="function"><span class="keyword">function</span>(<span class="params"> topic </span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>._topics[topic] = <span class="keyword">new</span> Topic( (<span class="keyword">this</span>.namespace ? <span class="keyword">this</span>.namespace + <span class="string">":"</span> : <span class="string">""</span>) + topic );</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="attr">HasTopic</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> topic </span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._topics.hasOwnProperty( topic );</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="attr">ReturnTopic</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> topic </span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._topics[topic];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果我们觉得不再需要它们了,我们也可以明确的删除这些订购用户.下面就是通过它的其子主题递归删除订购用户的代码:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">RemoveSubscriber: <span class="function"><span class="keyword">function</span>(<span class="params"> identifier </span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>( !identifier )&#123;</div><div class="line">    <span class="keyword">this</span>._callbacks = [];</div><div class="line"></div><div class="line">    <span class="keyword">for</span>( <span class="keyword">var</span> z <span class="keyword">in</span> <span class="keyword">this</span>._topics )&#123;</div><div class="line">      <span class="keyword">if</span>( <span class="keyword">this</span>._topics.hasOwnProperty(z) )&#123;</div><div class="line">        <span class="keyword">this</span>._topics[z].RemoveSubscriber( identifier );</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span>( <span class="keyword">var</span> y = <span class="number">0</span>, x = <span class="keyword">this</span>._callbacks.length; y &lt; x; y++ ) &#123;</div><div class="line">    <span class="keyword">if</span>( <span class="keyword">this</span>._callbacks[y].fn == identifier || <span class="keyword">this</span>._callbacks[y].id == identifier )&#123;</div><div class="line">      <span class="keyword">this</span>._callbacks[y].topic = <span class="literal">null</span>;</div><div class="line">      <span class="keyword">this</span>._callbacks.splice( y,<span class="number">1</span> );</div><div class="line">      x--; y--;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着我们通过递归子主题将发布任意参数的能够包含到订购服务对象中:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Publish: <span class="function"><span class="keyword">function</span>(<span class="params"> data </span>)</span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">for</span>( <span class="keyword">var</span> y = <span class="number">0</span>, x = <span class="keyword">this</span>._callbacks.length; y &lt; x; y++ ) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> callback = <span class="keyword">this</span>._callbacks[y], l;</div><div class="line">          callback.fn.apply( callback.context, data );</div><div class="line"></div><div class="line">      l = <span class="keyword">this</span>._callbacks.length;</div><div class="line"></div><div class="line">      <span class="keyword">if</span>( l &lt; x )&#123;</div><div class="line">        y--;</div><div class="line">        x = l;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span>( <span class="keyword">var</span> x <span class="keyword">in</span> <span class="keyword">this</span>._topics )&#123;</div><div class="line">      <span class="keyword">if</span>( !<span class="keyword">this</span>.stopped )&#123;</div><div class="line">        <span class="keyword">if</span>( <span class="keyword">this</span>._topics.hasOwnProperty( x ) )&#123;</div><div class="line">          <span class="keyword">this</span>._topics[x].Publish( data );</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.stopped = <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>接着我们暴露我们将主要交互的调节实体.这里它是通过注册的并且从主题中删除的事件来实现的<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Mediator</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> ( !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Mediator) ) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Mediator();</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    <span class="keyword">this</span>._topics = <span class="keyword">new</span> Topic( <span class="string">""</span> );</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>想要更多先进的用例,我们可以看看调解支持的主题命名空间,下面这样的asinbox:messages:new:read.GetTopic 返回基于一个命名空间的主题实体。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Mediator.prototype = &#123;</div><div class="line"></div><div class="line">  <span class="attr">GetTopic</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> namespace </span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> topic = <span class="keyword">this</span>._topics,</div><div class="line">        namespaceHierarchy = namespace.split( <span class="string">":"</span> );</div><div class="line"></div><div class="line">    <span class="keyword">if</span>( namespace === <span class="string">""</span> )&#123;</div><div class="line">      <span class="keyword">return</span> topic;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>( namespaceHierarchy.length &gt; <span class="number">0</span> )&#123;</div><div class="line">      <span class="keyword">for</span>( <span class="keyword">var</span> i = <span class="number">0</span>, j = namespaceHierarchy.length; i &lt; j; i++ )&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>( !topic.HasTopic( namespaceHierarchy[i]) )&#123;</div><div class="line">          topic.AddTopic( namespaceHierarchy[i] );</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        topic = topic.ReturnTopic( namespaceHierarchy[i] );</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> topic;</div><div class="line">  &#125;,</div></pre></td></tr></table></figure></p>
<p>这一节我们定义了一个Mediator.Subscribe方法，它接受一个主题命名空间,一个将要被执行的函数,选项和又一个在订阅中调用函数的上下文环境.这样就创建了一个主题,如果这样的一个主题存在的话<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Subscribe: <span class="function"><span class="keyword">function</span>(<span class="params"> topiclName, fn, options, context </span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> options = options || &#123;&#125;,</div><div class="line">      context = context || &#123;&#125;,</div><div class="line">      topic = <span class="keyword">this</span>.GetTopic( topicName ),</div><div class="line">      sub = topic.AddSubscriber( fn, options, context );</div><div class="line"></div><div class="line">  <span class="keyword">return</span> sub;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>根据这一点,我们可以进一步定义能够访问特定订阅用户,或者将他们从主题中递归删除的工具<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Returns a subscriber for a given subscriber id / named function and topic namespace</span></div><div class="line"></div><div class="line">GetSubscriber: <span class="function"><span class="keyword">function</span>(<span class="params"> identifier, topic </span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.GetTopic( topic || <span class="string">""</span> ).GetSubscriber( identifier );</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="comment">// Remove a subscriber from a given topic namespace recursively based on</span></div><div class="line"><span class="comment">// a provided subscriber id or named function.</span></div><div class="line"></div><div class="line">Remove: <span class="function"><span class="keyword">function</span>(<span class="params"> topicName, identifier </span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.GetTopic( topicName ).RemoveSubscriber( identifier );</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>我们主要的发布方式可以让我们随意发布数据到选定的主题命名空间，这可以在下面的代码中看到。</p>
<p>主题可以被向下递归.例如,一条对inbox:message的post将发送到inbox:message:new和inbox:message:new:read.它将像接下来这样被使用:Mediator.Publish( “inbox:messages:new”, [args] );<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Publish: <span class="function"><span class="keyword">function</span>(<span class="params"> topicName </span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call( <span class="built_in">arguments</span>, <span class="number">1</span>),</div><div class="line">        topic = <span class="keyword">this</span>.GetTopic( topicName );</div><div class="line"></div><div class="line">    args.push( topic );</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.GetTopic( topicName ).Publish( args );</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>最后，我们可以很容易的暴露我们的中间人，将它附着在传递到根中的对象上：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root.Mediator = Mediator;</div><div class="line">  Mediator.Topic = Topic;</div><div class="line">  Mediator.Subscriber = Subscriber;</div><div class="line"></div><div class="line">  <span class="comment">// Remember we can pass anything in here. I've passed inwindowto</span></div><div class="line">  <span class="comment">// attach the Mediator to, but we can just as easily attach it to another</span></div><div class="line">  <span class="comment">// object if desired.</span></div><div class="line">&#125;)( <span class="built_in">window</span> );</div></pre></td></tr></table></figure></p>
<h3 id="优点-amp-缺点"><a href="#优点-amp-缺点" class="headerlink" title="优点&amp;缺点"></a>优点&amp;缺点</h3><p>中间人模式最大的好处就是，它节约了对象或者组件之间的通信信道，这些对象或者组件存在于从多对多到多对一的系统之中。由于解耦合水平的因素，添加新的发布或者订阅者是相对容易的。</p>
<p>也许使用这个模式最大的缺点是它可以引入一个单点故障。在模块之间放置一个中间人也可能会造成性能损失，因为它们经常是间接地的进行通信的。由于松耦合的特性，仅仅盯着广播很难去确认系统是如何做出反应的。</p>
<p>这就是说，提醒我们自己解耦合的系统拥有许多其它的好处，是很有用的——如果我们的模块互相之间直接的进行通信，对于模块的改变（例如：另一个模块抛出了异常）可以很容易的对我们系统的其它部分产生多米诺连锁效应。这个问题在解耦合的系统中很少需要被考虑到。</p>
<p>在一天结束的时候，紧耦合会导致各种头痛，这仅仅只是另外一种可选的解决方案，但是如果得到正确实现的话也能够工作得很好。</p>
<h3 id="中间人Vs观察者"><a href="#中间人Vs观察者" class="headerlink" title="中间人Vs观察者"></a>中间人Vs观察者</h3><p>中间人模式最大的好处就是，它节约了对象或者组件之间的通信信道，这些对象或者组件存在于从多对多到多对一的系统之中。由于解耦合水平的因素，添加新的发布或者订阅者是相对容易的。</p>
<p>也许使用这个模式最大的缺点是它可以引入一个单点故障。在模块之间放置一个中间人也可能会造成性能损失，因为它们经常是间接地的进行通信的。由于松耦合的特性，仅仅盯着广播很难去确认系统是如何做出反应的。</p>
<p>这就是说，提醒我们自己解耦合的系统拥有许多其它的好处，是很有用的——如果我们的模块互相之间直接的进行通信，对于模块的改变（例如：另一个模块抛出了异常）可以很容易的对我们系统的其它部分产生多米诺连锁效应。这个问题在解耦合的系统中很少需要被考虑到。</p>
<p>在一天结束的时候，紧耦合会导致各种头痛，这仅仅只是另外一种可选的解决方案，但是如果得到正确实现的话也能够工作得很好。</p>
<h3 id="中间人Vs门面"><a href="#中间人Vs门面" class="headerlink" title="中间人Vs门面"></a>中间人Vs门面</h3><p>不久我们的描述就将涵盖门面模式，但作为参考之用，一些开发者也想知道中间人和门面模式之间有哪些相似之处。它们都对模块的功能进行抽象，但有一些细微的差别。</p>
<p>中间人模式让模块之间集中进行通信，它会被这些模块明确的引用。门面模式却只是为模块或者系统定义一个更加简单的接口，但不添加任何额外的功能。系统中其他的模块并不直接意识到门面的概念，而可以被认为是单向的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/17/JavaScript设计模式一/" itemprop="url">
                  JavaScript设计模式
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-17T10:13:37+08:00" content="2016-08-17">
              2016-08-17
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/17/JavaScript设计模式一/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/17/JavaScript设计模式一/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>A particular fine spring came around.</p>
</blockquote>
<h2 id="构造器模式"><a href="#构造器模式" class="headerlink" title="构造器模式"></a>构造器模式</h2><p>在面向对象编程中，构造器是一个当新建对象的内存被分配后，用来初始化该对象的一个特殊函数。在JavaScript中几乎所有的东西都是对象，我们经常会对对象的构造器十分感兴趣。<br>对象构造器是被用来创建特殊类型的对象的，首先它要准备使用的对象，其次在对象初次被创建时，通过接收参数，构造器要用来对成员的属性和方法进行赋值。</p>
<h3 id="对象创建"><a href="#对象创建" class="headerlink" title="对象创建"></a>对象创建</h3><p>下面是我们创建对象的三种基本方式：<br>下面的每一种都会创建一个新的对象：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> newObject = &#123;&#125;;</div><div class="line"></div><div class="line"><span class="comment">//or</span></div><div class="line"><span class="keyword">var</span> newObject = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</div><div class="line"></div><div class="line"><span class="comment">//or</span></div><div class="line"><span class="keyword">var</span> newObject = <span class="keyword">new</span> <span class="built_in">Object</span>();</div></pre></td></tr></table></figure></p>
<p>最后一个例子中”Object”构造器创建了一个针对特殊值的对象包装，只不过这里没有传值给它，所以它将会返回一个空对象。<br>有四种方式可以将一个键值对赋给一个对象：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// ECMAScript 3 兼容形式</span></div><div class="line"><span class="comment">//1.“点号”法</span></div><div class="line">newObject.someKey = <span class="string">"Hello World"</span>;</div><div class="line"></div><div class="line"><span class="comment">//获取属性</span></div><div class="line"><span class="keyword">var</span> key = newObject.someKey;</div><div class="line"></div><div class="line"><span class="comment">// 2. “方括号”法</span></div><div class="line"></div><div class="line"><span class="comment">// 设置属性</span></div><div class="line">newObject[<span class="string">"someKey"</span>] = <span class="string">"Hello World"</span>;</div><div class="line"></div><div class="line"><span class="comment">// 获取属性</span></div><div class="line"><span class="keyword">var</span> key = newObject[<span class="string">"someKey"</span>];</div><div class="line"></div><div class="line"><span class="comment">//ECMAScript 5 仅兼容性形式</span></div><div class="line"><span class="comment">//3.Object.defineProperty方式</span></div><div class="line"></div><div class="line"><span class="comment">//设置属性</span></div><div class="line"><span class="built_in">Object</span>.defineProperty(newObject, <span class="string">"someKey"</span>, &#123;</div><div class="line">  <span class="attr">value</span>: <span class="string">"hello world"</span>,</div><div class="line">  <span class="attr">writable</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">enumerable</span>: <span class="literal">true</span>,</div><div class="line">  <span class="attr">configurable</span>: <span class="literal">true</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//如果上面的方式你感到难以阅读，可以简短的写成下面这样：</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> defineProp = <span class="function"><span class="keyword">function</span>(<span class="params">obj, key, value</span>)</span>&#123;</div><div class="line">  config.value = value;</div><div class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, config);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//为了使用它，我么需要创建一个"person"对象</span></div><div class="line"><span class="keyword">var</span> person = <span class="built_in">Object</span>.create(<span class="literal">null</span>);</div><div class="line"></div><div class="line"><span class="comment">//用属性构造对象</span></div><div class="line">defineProp(person, <span class="string">"car"</span>, <span class="string">"Delorean"</span>);</div><div class="line">defineProp(person, <span class="string">"dateOfBirth"</span>, <span class="string">"1981"</span>);</div><div class="line">defineProp(person, <span class="string">"hasBeard"</span>, <span class="string">"false"</span>);</div><div class="line"></div><div class="line"><span class="comment">//4.Object.defineProperties方式</span></div><div class="line"><span class="built_in">Object</span>.defineProperties(newObject, &#123;</div><div class="line">  <span class="string">"someKey"</span>: &#123;</div><div class="line">     <span class="attr">value</span>: <span class="string">"Hello World"</span>,</div><div class="line">     <span class="attr">writable</span>: <span class="literal">true</span></div><div class="line">   &#125;,</div><div class="line"></div><div class="line">   <span class="string">"anotherKey"</span>: &#123;</div><div class="line">     <span class="attr">value</span>: <span class="string">"Foo bar"</span>,</div><div class="line">     <span class="attr">writable</span>: <span class="literal">false</span></div><div class="line">   &#125;</div><div class="line">&#125;)</div><div class="line"><span class="comment">// 3和4中的读取属行可用1和2中的任意一种</span></div></pre></td></tr></table></figure></p>
<p>在这本书的后面，这些方法会被用于继承，如下：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//创建一个继承与person的赛车司机</span></div><div class="line"><span class="keyword">var</span> driver = <span class="built_in">Object</span>.create(person);</div><div class="line"></div><div class="line"><span class="comment">//设置司机的属性</span></div><div class="line">defineProp(driver, <span class="string">"topSpeed"</span>, <span class="string">"100mph"</span>);</div><div class="line"></div><div class="line"><span class="comment">//获取继承的属性</span></div><div class="line"><span class="built_in">console</span>.log(driver.dateOfBirth);</div><div class="line"></div><div class="line"><span class="comment">//获取我们设置的属性</span></div><div class="line"><span class="built_in">console</span>.log(driver.topSpeed);</div></pre></td></tr></table></figure></p>
<h3 id="基础构造器"><a href="#基础构造器" class="headerlink" title="基础构造器"></a>基础构造器</h3><p>正如我们先前所看到的，javascript不支持类的概念，但它有一种与对象一起工作的构造器函数。使用new关键字来调用该函数，我们可以告诉JavaScript把这个函数当做一个构造器来用，它可以用自己所定义的成员来初始化一个对象。</p>
<p>在这个构造器内部，关键字this引用到刚被创建的对象。回到对象创建，一个基本的构造函数看起来像这样：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Car</span>(<span class="params">model, year, miles</span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.model = model;</div><div class="line">  <span class="keyword">this</span>.year = year;</div><div class="line">  <span class="keyword">this</span>.miles = miles;</div><div class="line"></div><div class="line">  <span class="keyword">this</span>.toString = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.model + <span class="keyword">this</span>.miles;</div><div class="line">  &#125;;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//使用，我们可以实例化一个Car</span></div><div class="line"><span class="keyword">var</span> civic = <span class="keyword">new</span> Car(<span class="string">"Honda Civic"</span>, <span class="number">2009</span>, <span class="number">20000</span>);</div><div class="line"><span class="keyword">var</span> mondeo = <span class="keyword">new</span> Car(<span class="string">"Ford Mondeo"</span>, <span class="number">2010</span>, <span class="number">5000</span>);</div><div class="line"></div><div class="line"><span class="comment">//output of the toString() method being called on these objects</span></div><div class="line"><span class="built_in">console</span>.log(civic.toString());</div><div class="line"><span class="built_in">console</span>.log(mondeo.toString());</div></pre></td></tr></table></figure></p>
<p>上面这是个简单版本的构造器模式，但它还是有些问题。一个是难以继承，另一个是每个Car构造函数创建的对象中，toString()之类的函数都被重新定义。这不是非常好，理想的情况是所有Car类型的对象都应该应用同一个函数。ECMAScript3和ECMAScript5-兼容版，对于构造对象他们提供了另外一些选择，解决限制小菜一碟。</p>
<h3 id="使用“原型”的构造器"><a href="#使用“原型”的构造器" class="headerlink" title="使用“原型”的构造器"></a>使用“原型”的构造器</h3><p>在JavaScript中函数有一个prototype的属性。当我们调用JavaScript的构造器创建一个对象时，构造函数prototype上的属性对于所创建的对象来说都可见。照这样，就可以创建多个访问相同prototype的Car对象了。下面，我们来扩展一下原来的例子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Car</span>(<span class="params">model, year, miles</span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.model = model;</div><div class="line">  <span class="keyword">this</span>.year = year;</div><div class="line">  <span class="keyword">this</span>.miles = miles;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Car.prototype.toString = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.model + <span class="string">" has done "</span> + <span class="keyword">this</span>.miles + <span class="string">" miles"</span>;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">var</span> civic = <span class="keyword">new</span> Car( <span class="string">"Honda Civic"</span>, <span class="number">2009</span>, <span class="number">20000</span> );</div><div class="line"><span class="keyword">var</span> mondeo = <span class="keyword">new</span> Car( <span class="string">"Ford Mondeo"</span>, <span class="number">2010</span>, <span class="number">5000</span> );</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log( civic.toString() );</div><div class="line"><span class="built_in">console</span>.log( mondeo.toString() );</div></pre></td></tr></table></figure></p>
<p>通过上面的代码，单个toString()实例被所有的Car对象所共享。</p>
<h2 id="模块化模式"><a href="#模块化模式" class="headerlink" title="模块化模式"></a>模块化模式</h2><p><strong>模块</strong><br>模块是任何健壮的应用程序体系结构不可或缺的一部分，特点是有助于保持应用项目的代码单元技能清晰地分离又有组织。<br>在JavaScript中，实现模块有几个选项，他们包括：</p>
<ul>
<li>模块化模式</li>
<li>对象表示法</li>
<li>AMD模块</li>
<li>CommonJS模块</li>
<li>ECMAScript Harmony模块<br>模块化模式是基于对象的文字部分。</li>
</ul>
<h3 id="对象字面量"><a href="#对象字面量" class="headerlink" title="对象字面量"></a>对象字面量</h3><p>在对象字面值的标记里，一个对象被描述为一组以逗号分隔的名称/值对括在大括号({})的集合。对象内部的名称可以是字符串或是标记符后跟着一个冒号”:”。在对象里最后一个名称/值对不应该以”,”为结束符，因为这样会导致错误。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myObjectLiteral = &#123;</div><div class="line">  <span class="attr">variableKey</span>: variableValue,</div><div class="line">  <span class="attr">functionKey</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对象字面量不要求使用新的操作实例，但是不能够在结构体开始使用，因为打开”{“可能被解释为一个块的开始。在对象外新的成员会被加载，使用分配如下：smyModule.prototype = “someValue”;下面我们可以看到一个更完整的使用对象字面值定义一个模块的例子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myModule = &#123;</div><div class="line">  <span class="attr">myProperty</span>: <span class="string">"someValue"</span>,</div><div class="line">  <span class="attr">myConfig</span>: &#123;</div><div class="line">    <span class="attr">useCaching</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">language</span>: <span class="string">"en"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">myMethod</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log( <span class="string">"Where in the world is Paul Irish today?"</span> );</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">myMethod2</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log( <span class="string">"Caching is:"</span> + ( <span class="keyword">this</span>.myConfig.useCaching ) ? <span class="string">"enabled"</span> : <span class="string">"disabled"</span> );</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">myMethod3</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> newConfig </span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> ( <span class="keyword">typeof</span> newConfig === <span class="string">"object"</span> ) &#123;</div><div class="line">      <span class="keyword">this</span>.myConfig = newConfig;</div><div class="line">      <span class="built_in">console</span>.log( <span class="keyword">this</span>.myConfig.language );</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">// 输出: Where in the world is Paul Irish today?</span></div><div class="line">myModule.myMethod();</div><div class="line"></div><div class="line"><span class="comment">// 输出: enabled</span></div><div class="line">myModule.myMethod2();</div><div class="line"></div><div class="line"><span class="comment">// 输出: fr</span></div><div class="line">myModule.myMethod3(&#123;</div><div class="line">  <span class="attr">language</span>: <span class="string">"fr"</span>,</div><div class="line">  <span class="attr">useCaching</span>: <span class="literal">false</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>使用对象字面值可以协助封装和组织你的代码。也就是说，如果我们选择了这种技术，我们可能对模块模式有同样的兴趣。即使使用对象字面值，但也只有一个函数的返回值。</p>
<h3 id="模块化模式-1"><a href="#模块化模式-1" class="headerlink" title="模块化模式"></a>模块化模式</h3><p>模块化模式最初被定义为一种对传统软件工程的类提供私有和公共封装的方法。<br>在JavaScript中，模块化模式用来进一步模拟类的概念，通过这样一种方式：我们可以在一个单一的对象中包含公共/私有的方法和变量，从而从全局范围中屏蔽特定的部分。这个结果是可以减少我们的函数名称与在页面中其他脚本区域定义的函数名称冲突的可能性。</p>
<h3 id="私有信息"><a href="#私有信息" class="headerlink" title="私有信息"></a>私有信息</h3><p>模块模式使用闭包的方式来将“私有信息”，状态和组织结构封装起来。提供了一种将公有和私有方法，变量封装混合在一起的方式，这种方式防止内部信息泄露到全局中，从而避免了和其他开发者发生冲突的可能性。在这种模式下只有公有的API会返回，其它将全部保留在闭包的私有空间中。</p>
<p>这种方法提供了一个比较清晰的解决方案，在只暴露一个接口供其它部分使用的情况下，将执行繁重任务的逻辑保护起来。这个模式非常类似于立即调用函数表达式，但是这种模式返回的是对象，而立即调用函数表达式返回的是一个函数。</p>
<p>需要注意的是，在javaScript事实上没有一个显式的真正意义上的”私有化”概念，因为与传统语言不同，javaScript没有访问修饰符。从技术上将，变量不能被声明为公有的或私有的，因此我们使用函数域的方式去模拟这个概念。在模块模式中，因为闭包的缘故，声明的变量或者方法只在模块内部有效。在返回对象中定义的变量或者方法可以供任何人使用。</p>
<p><strong>例子</strong><br>下面这个例子通过创建一个自包含的模块实现了模块模式。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> testModule = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> counter = <span class="number">0</span>;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">incrementCounter</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="keyword">return</span> counter++;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="attr">resetCounter</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">"counter: "</span>,counter);</div><div class="line">      counter = <span class="number">0</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;)();</div><div class="line"></div><div class="line"><span class="comment">//Increment our counter</span></div><div class="line">testModule.incrementCounter();</div><div class="line"></div><div class="line"><span class="comment">//Check the counter value and reset</span></div><div class="line"><span class="comment">//Outputs: 1</span></div><div class="line">testModule.resetCounter();</div></pre></td></tr></table></figure></p>
<p>在这里我们看到，其它部分的代码不能访问我们的incrementCounter()或者resetCounter()的值。counter变量被完全从全局域中隔离起来了，因此其表现的就像一个私有变量一样，它的存在只局限于模块的闭包内部，因此只有两个函数可以访问counter。我们的方法是有名字空间限制的，因此在我们代码的测试部分，我们需要给所有函数调用前面加上模块的名字(例如:”testModule”)。</p>
<p>当使用模块模式时，我们会发现通过使用简单的模板，对于开始使用模式非常有用。下面是一个模板包好了命名空间，公共变量和私有变量。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myNamespace = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> myPrivateVar, myPrivateMethod;</div><div class="line"></div><div class="line">  <span class="comment">//A private counter variable</span></div><div class="line">  myPrivateVar = <span class="number">0</span>;</div><div class="line"></div><div class="line">  <span class="comment">//A private function which logs any arguments</span></div><div class="line">  myPrivateMethod = <span class="function"><span class="keyword">function</span>(<span class="params">foo</span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(foo);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="comment">//A public valiable</span></div><div class="line">    myPublicVar: <span class="string">"foo"</span>,</div><div class="line"></div><div class="line">    <span class="comment">//A public function utilizing privates</span></div><div class="line">    myPublicFunction: <span class="function"><span class="keyword">function</span>(<span class="params">bar</span>)</span>&#123;</div><div class="line">      <span class="comment">// Increment our private counter</span></div><div class="line">      myPrivateVar++;</div><div class="line"></div><div class="line">      <span class="comment">// Call our private method using bar</span></div><div class="line">      myPrivateMethod( bar );</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure></p>
<p>看一下另外一个例子，下面我们看到一个使用这种模式实现的购物车。这个模块完全自包含在一个叫做basketModule全局变量中。模块中的购物车数组是私有的，应用的其他部分不能直接读取。只存在与模块的闭包中，因此只有可以访问其域的方法可以访问这个变量。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> basketModule = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">// privates</span></div><div class="line">  <span class="keyword">var</span> basket = [];</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">doSomethingPrivate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">doSomethingElsePrivate</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Return an object exposed to the public</span></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="comment">// Add items to our basket</span></div><div class="line">    addItem: <span class="function"><span class="keyword">function</span>(<span class="params"> values </span>) </span>&#123;</div><div class="line">      basket.push(values);</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// Get the count of items in the basket</span></div><div class="line">    getItemCount: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">return</span> basket.length;</div><div class="line">    &#125;,</div><div class="line"></div><div class="line">    <span class="comment">// Public alias to a  private function</span></div><div class="line">    doSomething: doSomethingPrivate,</div><div class="line"></div><div class="line">    <span class="comment">// Get the total value of items in the basket</span></div><div class="line">    getTotal: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">      <span class="keyword">var</span> q = <span class="keyword">this</span>.getItemCount(),</div><div class="line">          p = <span class="number">0</span>;</div><div class="line"></div><div class="line">      <span class="keyword">while</span> (q--) &#123;</div><div class="line">        p += basket[q].price;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> p;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure></p>
<p>在模块内部，你可能注意到我们返回了另外一个对象。这个自动赋值给了basketModule因此我们可以这样和这个对象交互。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// basketModule returns an object with a public API we can use</span></div><div class="line"></div><div class="line">basketModule.addItem(&#123;</div><div class="line">  <span class="attr">item</span>: <span class="string">"bread"</span>,</div><div class="line">  <span class="attr">price</span>: <span class="number">0.5</span></div><div class="line">  &#125;);</div><div class="line"></div><div class="line">basketModule.addItem(&#123;</div><div class="line">  <span class="attr">item</span>: <span class="string">"butter"</span>,</div><div class="line">  <span class="attr">price</span>: <span class="number">0.3</span></div><div class="line">  &#125;);</div><div class="line"></div><div class="line"><span class="comment">// Outputs: 2</span></div><div class="line"><span class="built_in">console</span>.log( basketModule.getItemCount() );</div><div class="line"></div><div class="line"><span class="comment">// Outputs: 0.8</span></div><div class="line"><span class="built_in">console</span>.log( basketModule.getTotal() );</div><div class="line"></div><div class="line"><span class="comment">// However, the following will not work:</span></div><div class="line"></div><div class="line"><span class="comment">// Outputs: undefined</span></div><div class="line"><span class="comment">// This is because the basket itself is not exposed as a part of our</span></div><div class="line"><span class="comment">// the public API</span></div><div class="line"><span class="built_in">console</span>.log( basketModule.basket );</div><div class="line"></div><div class="line"><span class="comment">// This also won't work as it only exists within the scope of our</span></div><div class="line"><span class="comment">// basketModule closure, but not the returned public object</span></div><div class="line"><span class="built_in">console</span>.log( basket );</div></pre></td></tr></table></figure></p>
<p>上面的方法都处于basketModule的名字空间中。<br>请注意在上面的basket模块中，域函数是如何在我们所有的函数中被封装起来的，以及我们如何立即调用这个域函数，并且将返回值保存下来。这种方式有以下的优势：</p>
<ul>
<li>可以创建只能被我们模块访问的私有函数。这些函数没有暴露出来(只有一些API是暴露出来的)，它们被认为是完全私有的。</li>
<li>当我们在一个调试器中，需要发现哪个函数抛出异常的时候，可以很容易的看到调用栈，因为这些函数是正常声明的并且是命名的函数。</li>
<li>这种模式同样可以让我们在不同的情况下返回不同的函数。我见过有开发者使用这种技巧用于执行UA测试，目的是为了在它们的模块里面针对IE专门提供一条代码路径，但是现在我们也可以简单的使用特征检测达到相同的目的。</li>
</ul>
<h3 id="Import-mixins-导入混合"><a href="#Import-mixins-导入混合" class="headerlink" title="Import mixins(导入混合)"></a>Import mixins(导入混合)</h3><p>这个变体展示了如何将全局(例如jQuery, Underscore)作为一个参数传入模块的匿名函数。这种方式允许我们导入全局，并且按照我们的想法在本地为这些全局起一个别名。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Global module</span></div><div class="line"><span class="keyword">var</span> myModule = (<span class="function"><span class="keyword">function</span>(<span class="params">jQ, _ </span>)</span>&#123;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">privateMethod1</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    jQ(<span class="string">".container"</span>).html(<span class="string">"test"</span>);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">privateMethod2</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(_.min([<span class="number">10</span>,<span class="number">5</span>,<span class="number">100</span>,<span class="number">2</span>,<span class="number">1000</span>]));</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">publicMethod</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      privateMethod1();</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)(jQuery, _);</div><div class="line"></div><div class="line">myModule.publicMethod();</div></pre></td></tr></table></figure></p>
<h3 id="Exports-导出"><a href="#Exports-导出" class="headerlink" title="Exports(导出)"></a>Exports(导出)</h3><p>这个变体允许我们声明全局对象而不是使用它们，同样也支持在下一个例子中我们将会看到的全局导入的概念。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Global module</span></div><div class="line"><span class="keyword">var</span> myModule = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">//Module object</span></div><div class="line">  <span class="keyword">var</span> <span class="built_in">module</span> = &#123;&#125;, privateVariable = <span class="string">"Hello World"</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">privateMethod</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="built_in">module</span>.publicProperty = <span class="string">"Foobar"</span>;</div><div class="line">  <span class="built_in">module</span>.publicMethod = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(privateVariable);</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="built_in">module</span>;</div><div class="line">&#125;)()</div></pre></td></tr></table></figure></p>
<p>工具箱和框架特定的模块模式实现。</p>
<p><strong>jQuery</strong><br>因为jQuery编码规范没有规定插件如何实现模块模式，因此有很多方式可以实现模块模式。在下面的例子中，定义了一个library函数，这个函数声明了一个新的库，并且在新的库(例如模块)创建的时候，自动将初始化函数绑定到document的ready上。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">library</span>(<span class="params">module</span>)</span>&#123;</div><div class="line">  $(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="built_in">module</span>.init)&#123;</div><div class="line">      <span class="built_in">module</span>.init();</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">  <span class="keyword">return</span> <span class="built_in">module</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> myLibrary = library(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="attr">init</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="comment">//module implementation</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure></p>
<p><strong>优势</strong><br>既然我们已经看到单例模式很有用，为什么还是使用模块模式呢？首先，对于有面向对象背景的开发者来讲，至少从javascript语言上来讲，模块模式相对于真正的封装概念更清晰。</p>
<p>其次，模块模式支持私有数据，因此在模块模式中，公共部分代码可以访问私有化数据，但是在模块外部，不能访问类的私有部分。</p>
<p><strong>缺点</strong><br>模块模式的缺点是因为我们采用不同的方式访问公有和私有成员，因此当我们想要改变这些成员的可见性的时候，我们不得不在所有使用这些成员的地方修改代码。</p>
<p>我们也不能在对象之后添加的方法里面访问这些私有变量。也就是说，很多情况下，模块模式很有用，并且当使用正确的时候，潜在地可以改善我们代码的结构。</p>
<p>其它缺点包括不能为私有成员创建自动化的单元测试，以及在紧急修复bug时所带来的额外的复杂性。根本没有可能可以对私有成员打补丁。相反地，我们必须覆盖所有的使用存在bug私有成员的公共方法。开发者不能简单的扩展私有成员，因此我们需要记得，私有成员并非它们表面上看上去那么具有扩展性。</p>
<h2 id="暴露模块模式"><a href="#暴露模块模式" class="headerlink" title="暴露模块模式"></a>暴露模块模式</h2><p>既然我们对模块模式已经有一些了解，让我们看一下改进版本 - Christian Heilmann的启发模块模式。启发模块模式来自于，当Heilmann对这样一个现状的不满，即当我们想要在一个公有方法中调用链另一个公有方法，或者访问公有变量的时候，我们不得不重复主对象的名称。他也不喜欢模块模式中，当想要将某个成员变成公共成员时，修改文字标记的做法。</p>
<p>因此他工作的结果就是一个更新的模式，在这个模式中，我们可以简单地在私有域中定义我们所有的函数和变量，并且返回一个匿名对象，这个对象包含有一些指针，这些指针指向我们想要暴露出来的私有成员，使这些私有成员公有化。</p>
<p>下面给出了一个如何使用暴露式模块模式的例子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myRevealingModule = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> privateVar = <span class="string">"Ben Cherry"</span>,</div><div class="line">      publicVar = <span class="string">"Hey there!"</span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">privateFunction</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"Name: "</span> + privateVar);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">publicSetName</span>(<span class="params"> strName </span>) </span>&#123;</div><div class="line">      privateVar = strName;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">publicGetName</span>(<span class="params"></span>) </span>&#123;</div><div class="line">      privateFunction();</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Reveal public pointers to</span></div><div class="line">  <span class="comment">// private functions and properties</span></div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">setName</span>: publicSetName,</div><div class="line">      <span class="attr">greeting</span>: publicVar,</div><div class="line">      <span class="attr">getName</span>: publicGetName</div><div class="line">  &#125;;</div><div class="line">&#125;();</div><div class="line"></div><div class="line">myRevealingModule.setName(<span class="string">"Paul Kinlan"</span>);</div></pre></td></tr></table></figure></p>
<p>这个模式可以用于将私有函数和属性以更加规范的命名方式展现出来。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> myRevealingModule = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> privateCounter = <span class="number">0</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">privateFunction</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        privateCounter++;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">publicFunction</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        publicIncrement();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">publicIncrement</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        privateFunction();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">publicGetCount</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="keyword">return</span> privateCounter;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Reveal public pointers to</span></div><div class="line">    <span class="comment">// private functions and properties       </span></div><div class="line"></div><div class="line">   <span class="keyword">return</span> &#123;</div><div class="line">        <span class="attr">start</span>: publicFunction,</div><div class="line">        <span class="attr">increment</span>: publicIncrement,</div><div class="line">        <span class="attr">count</span>: publicGetCount</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">&#125;();</div><div class="line"></div><div class="line">myRevealingModule.start();</div></pre></td></tr></table></figure></p>
<p> <strong>优势</strong><br>这个模式是我们脚本的语法更加一致。同样在模块的最后关于那些函数和变量可以被公共访问也变得更加清晰，增强了可读性。</p>
<p> <strong>缺点</strong><br>这个模式的一个缺点是如果私有函数需要使用公有函数，那么这个公有函数在需要打补丁的时候就不能被重载。因为私有函数仍然使用的是私有的实现，并且这个迷失不能用于公有成员，只用于函数。<br>公有成员使用私有成员也遵循上面不能打补丁的规则。<br>因为上面的原因，使用暴露式模块模式创建的模块相对于原始的模块模式更容易出问题，因此在使用的时候需要小心。</p>
<h2 id="单例模块"><a href="#单例模块" class="headerlink" title="单例模块"></a>单例模块</h2><p>单例模式之所以这么叫，是因为它限制一个类只能有一个实例化对象。经典的实现方式是，创建一个类，这个类包含一个方法，这个方法在没有对象存在的情况下，将会创建一个新的实例对象。如果对象存在，这个方法只是返回这个对象的引用。</p>
<p>单例和静态类不同，因为我们可以退出单例的初始化时间。通常这样做是因为，在初始化的时候需要一些额外的信息，而这些信息在声明的时候无法得知。对于并不知晓对单例模式引用的代码来讲，单例模式没有为它们提供一种方式可以简单的获取单例模式。这是因为，单例模式既不返回对象也不返回类，它只返回一种结构。可以类比闭包中的变量不是闭包，提供闭包的函数域是闭包。</p>
<p>在JavaScript语言中，单例服务作为一个从全局空间的代码实现中隔离出来共享的资源空间是为了提供一个单独的函数访问指针。</p>
<p>我们能像这样实现一个单例：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mySingleton = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">//Instance stores a reference to the Singleton</span></div><div class="line">  <span class="keyword">var</span> instance;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="comment">//单例</span></div><div class="line">    <span class="comment">//私有方法和变量</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">privateMethod</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="built_in">console</span>.log(<span class="string">"I am private"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> privateVariable = <span class="string">"I am also private"</span>;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> privateRandomNumber = <span class="built_in">Math</span>.random();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="comment">// 共有方法和变量</span></div><div class="line">      publicMethod: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log( <span class="string">"The public can see me!"</span> );</div><div class="line">      &#125;,</div><div class="line"></div><div class="line">      <span class="attr">publicProperty</span>: <span class="string">"I am also public"</span>,</div><div class="line"></div><div class="line">      <span class="attr">getRandomNumber</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="keyword">return</span> privateRandomNumber;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="comment">//如果存在获取此单例实例，如果不存在创建一个单例实例</span></div><div class="line">    getInstance: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      <span class="keyword">if</span>(!instance)&#123;</div><div class="line">        instance = init();</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;)();</div><div class="line"></div><div class="line"><span class="keyword">var</span> myBadSingleton = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">//存储单例实例的引用</span></div><div class="line">  <span class="keyword">var</span> instance;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">init</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="comment">//单例</span></div><div class="line">    <span class="keyword">var</span> privateRandomNumber = <span class="built_in">Math</span>.random();</div><div class="line"></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">getRandomNumber</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="keyword">return</span> privateRandomNumber;</div><div class="line">      &#125;</div><div class="line">    &#125;;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">    <span class="comment">//总是创建一个新的实例</span></div><div class="line">    getInstance: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">      instance = init();</div><div class="line">      <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)();</div><div class="line"></div><div class="line"><span class="comment">//使用</span></div><div class="line"><span class="keyword">var</span> singleA = mySingleton.getInstance();</div><div class="line"><span class="keyword">var</span> singleB = mySingleton.getInstance();</div><div class="line"><span class="built_in">console</span>.log( singleA.getRandomNumber() === singleB.getRandomNumber() ); <span class="comment">// true</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> badSingleA = myBadSingleton.getInstance();</div><div class="line"><span class="keyword">var</span> badSingleB = myBadSingleton.getInstance();</div><div class="line"><span class="built_in">console</span>.log( badSingleA.getRandomNumber() !== badSingleB.getRandomNumber() ); <span class="comment">// true</span></div></pre></td></tr></table></figure></p>
<p>创建一个全局访问的单例实例(通常通过MySingleton.getInstance())因为我们不能(至少在静态语言中)直接调用new MySingleton()创建实例。这在javascript语言中是不可能的。<br>单例模式的描述如下：</p>
<ul>
<li>每个类只有一个实例，这个实例必须通过一个广为人知的接口，来被客户访问。</li>
<li>子类如果要扩展这个唯一的实例，客户可以不用修改代码就能使用这个扩展后的实例。<br>关于第二点，可以参考如下的实例，我们需要这样编码：<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">mySingleton.getInstance = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>._instance == <span class="literal">null</span>)&#123;</div><div class="line">    <span class="keyword">this</span>._instance = <span class="keyword">new</span> FooSingleton();</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    <span class="keyword">this</span>._instance = <span class="keyword">new</span> BasicSingleton();</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._instance;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>在这里，getInstance 有点类似于工厂方法，我们不需要去更新每个访问单例的代码。FooSingleton可以是BasicSinglton的子类，并且实现了相同的接口。<br>为什么对于单例模式来讲，延迟执行这么重要？</p>
<p><strong>在C++代码中，单例模式将不可预知的动态初始化顺序问题隔离掉，将控制权返回给程序员。</strong><br>区分类的静态实例和单例模式很重要：尽管单例模式可以被实现成一个静态实例，但是单例可以懒构造，在真正用到之前，单例模式不需要分配资源或者内存。<br>如果我们有个静态对象可以被直接初始化，我们需要保证代码总是以同样的顺序执行当你有很多源文件的时候，这种方式没有可扩展性。<br>单例模式和静态对象都很有用，但是不能滥用-同样的我们也不能滥用其他模式。<br>在实践中，当一个对象需要和另外的对象进行跨系统协作的时候，单例模式很有用。下面是一个单例模式在这种情况下使用的例子：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> SingletonTester = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="comment">// options: an object containing configuration options for the singleton</span></div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">Singleton</span>(<span class="params">options</span>)</span>&#123;</div><div class="line">    options = options || &#123;&#125;;</div><div class="line">    <span class="keyword">this</span>.name = <span class="string">"SingletonTesterer"</span>;</div><div class="line">    <span class="keyword">this</span>.pointX = options.pointX || <span class="number">6</span>;</div><div class="line">    <span class="keyword">this</span>.pointY = options.pointX || <span class="number">10</span>;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">var</span> instance;</div><div class="line">  <span class="keyword">var</span> _static = &#123;</div><div class="line">    <span class="attr">name</span>: <span class="string">"SingletonTesterer"</span>,</div><div class="line">    <span class="attr">getInstance</span>: <span class="function"><span class="keyword">function</span>(<span class="params">options</span>)</span>&#123;</div><div class="line">      <span class="keyword">if</span>(instance === <span class="literal">undefined</span>)&#123;</div><div class="line">        instance = <span class="keyword">new</span> Singleton(options);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> instance;</div><div class="line">    &#125;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> _static;</div><div class="line">&#125;)();</div><div class="line"></div><div class="line"><span class="keyword">var</span> singletonTest = SingletonTesterer.getInstance(&#123;</div><div class="line">  <span class="attr">pointX</span>: <span class="number">5</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="built_in">console</span>.log(singletonTest.pointX);</div></pre></td></tr></table></figure></p>
<p>尽管单例模式有着合理的使用需求，但是通常当我们发现自己需要在javascript使用它的时候，这是一种信号，表明我们可能需要去重新评估自己的设计。<br>这通常表明系统中的模块要么紧耦合要么逻辑过于分散在代码库的多个部分。单例模式更难测试，因为可能有多种多样的问题出现，例如隐藏的依赖关系，很难去创建多个实例，很难理清依赖关系，等等。</p>
<h2 id="观察者模式"><a href="#观察者模式" class="headerlink" title="观察者模式"></a>观察者模式</h2><p>观察者模式是这样一种设计模式。一个被称作被观察者的对象，维护一组被称为观察者的对象，这些对象依赖于被观察者，被观察者自动将自身的状态的任何变化通知给它们。</p>
<p>当一个被观察者需要将一些变化通知给观察者的时候，它将采用广播的方式，这条广播可能包含特定于这条通知的一些数据。</p>
<p>当特定的观察者不再需要接受来自于它所注册的被观察者通知的时候，被观察者可以将其从所维护的组中删除。在这里提及一下设计模式现有的定义很有必要。这个定义是与所使用的语言无关的。通过这个定义，最终我们可以更深层次地了解设计模式如何使用以及其优势。在四人帮的《设计模式：可重用的面向对象软件的元素》这本书中，是这样定义观察者模式的：</p>
<p>一个或者更多的观察者对一个被观察者的状态感兴趣，将自身的这种感兴趣通过附着自身的方式注册在被观察者身上。防备观察者发生变化，而这种便可也是观察者所关心的，就会产生一个通知，这个通知将会被送出去，最后将会调用每个观察者的更新方法。当观察者不在对被观察者的状态感兴趣的时候，它们只需要简单的将自身剥离即可。</p>
<p>我们现在可以通过实现一个观察者模式来进一步扩展我们刚才所学的东西。这个实现包含以下组件：</p>
<ul>
<li>被观察者：维护一组观察者，提供用于增加和移除观察者的方法。</li>
<li>观察者：提供一个更新接口，用于当被观察者状态变化时，得到通知。</li>
<li>具体的被观察者：状态变化时广播通知给观察者，保持具体的观察者的信息。</li>
<li>具体的观察者：保持一个纸箱具体被观察者的引用，实现一个更新接口，用于观察，以便保证自身状态总是和被观察者状态一致的。</li>
</ul>
<p>首先，让我们对被观察者可能有的一组依赖其的观察者进行建模：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">ObserverList</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.observerList = [];</div><div class="line">&#125;</div><div class="line"></div><div class="line">ObserverList.prototype.Add = <span class="function"><span class="keyword">function</span>(<span class="params">obj</span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.observerList.push(obj);</div><div class="line">&#125;</div><div class="line"></div><div class="line">ObserverList.prototype.Empty = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.observerList = [];</div><div class="line">&#125;</div><div class="line"></div><div class="line">ObserverList.prototype.Count = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.observerList.length;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ObserverList.prototype.Get = <span class="function"><span class="keyword">function</span>(<span class="params">index</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(index &gt; <span class="number">-1</span> &amp;&amp; index &lt; <span class="keyword">this</span>.observerList.length)&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.observerList[index]</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ObserverList.prototype.Insert = <span class="function"><span class="keyword">function</span>(<span class="params">obj,index</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> pointer = <span class="number">-1</span>;</div><div class="line"></div><div class="line">  <span class="keyword">if</span>(index === <span class="number">0</span>)&#123;</div><div class="line">    <span class="keyword">this</span>.observerList.unshift(obj);</div><div class="line">    pointer = index;</div><div class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(index === <span class="keyword">this</span>.observerList.length)&#123;</div><div class="line">    <span class="keyword">this</span>.observerList.push(obj);</div><div class="line">    pointer = index;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> pointer;</div><div class="line">&#125;</div><div class="line"></div><div class="line">ObserverList.prototype.IndexOf = <span class="function"><span class="keyword">function</span>(<span class="params">obj,startIndex</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> i = startIndex, pointer = <span class="number">-1</span>;</div><div class="line">  <span class="keyword">while</span>(i&lt; <span class="keyword">this</span>.observerList.length)&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>.observerList[i] === obj)&#123;</div><div class="line">      pointer = i;</div><div class="line">    &#125;</div><div class="line">    i++;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> pointer;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">ObserverList.prototype.RemoveAt = <span class="function"><span class="keyword">function</span>(<span class="params">index</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(index === <span class="number">0</span>)&#123;</div><div class="line">    <span class="keyword">this</span>.observerList.shift();</div><div class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(index === <span class="keyword">this</span>.observerList.length <span class="number">-1</span>)&#123;</div><div class="line">    <span class="keyword">this</span>.observerList.pop();</div><div class="line">  &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="comment">//Extend an object with an extension</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">extend</span>(<span class="params">extension, obj</span>)</span>&#123;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> key <span class="keyword">in</span> extension)&#123;</div><div class="line">    obj[key] = extension[key];</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着，我们对被观察者以及其增加、删除，通知在观察者列表中的观察者的能力进行建模：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Subject</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.observers = <span class="keyword">new</span> ObserverList();</div><div class="line">&#125;</div><div class="line"></div><div class="line">Subject.prototype.AddObserver = <span class="function"><span class="keyword">function</span>(<span class="params">observer</span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.observers.Add(observer);</div><div class="line">&#125;</div><div class="line"></div><div class="line">Subject.prototype.RemoveObserver = <span class="function"><span class="keyword">function</span>(<span class="params">observer</span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.observers.RemoveAt(<span class="keyword">this</span>.observers.IndexOf(observer,<span class="number">0</span>));</div><div class="line">&#125;;</div><div class="line"></div><div class="line">Subject.prototype.Notify = <span class="function"><span class="keyword">function</span>(<span class="params">context</span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> observerCount = <span class="keyword">this</span>.observers.Count();</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt; observerCount; i++)&#123;</div><div class="line">    <span class="keyword">this</span>.observers.Get(i).Update(context);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们接着定义建立新的观察者的一个框架。这里的update函数之后会被具体的行为覆盖。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//The Observer</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Observer</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.update = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="comment">//...</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在我们的样例应用里面，我们使用上面的观察者组件，现在我们定义：</p>
<ul>
<li>一个按钮，这个按钮用于增加新的充当观察者的选择框到页面上</li>
<li>一个控制用的额选择框，充当一个被观察者，通知其它选择框是否用该被选中</li>
<li>一个容器，用于放置新的选择框</li>
</ul>
<p>我们接着定义具体被观察者和具体观察者，用于给页面增加新的观察者，以及实现更新接口。通过查看下面的内联的注释，搞清楚在我们的样例中的这些组件是如何工作的。</p>
<p><strong>HTML</strong><br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;button id="addNewObserver"&gt;Add New Observer checkbox&lt;/button&gt;</div><div class="line">&lt;input id="mainCheckbox" type="checkbox"/&gt;</div><div class="line">&lt;div id="observersContainer"&gt;&lt;/div&gt;</div></pre></td></tr></table></figure></p>
<p><strong>Sample script</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 我们DOM 元素的引用</span></div><div class="line"></div><div class="line"><span class="keyword">var</span> controlCheckbox = <span class="built_in">document</span>.getElementById( <span class="string">"mainCheckbox"</span> ),</div><div class="line">addBtn = <span class="built_in">document</span>.getElementById( <span class="string">"addNewObserver"</span> ),</div><div class="line">container = <span class="built_in">document</span>.getElementById( <span class="string">"observersContainer"</span> );</div><div class="line"></div><div class="line"><span class="comment">// 具体的被观察者</span></div><div class="line"></div><div class="line"><span class="comment">//Subject 类扩展controlCheckbox 类</span></div><div class="line">extend( <span class="keyword">new</span> Subject(), controlCheckbox );</div><div class="line"></div><div class="line"><span class="comment">//点击checkbox 将会触发对观察者的通知</span></div><div class="line">controlCheckbox[<span class="string">"onclick"</span>] = <span class="keyword">new</span> <span class="built_in">Function</span>( <span class="string">"controlCheckbox.Notify(controlCheckbox.checked)"</span> );</div><div class="line"></div><div class="line">addBtn[<span class="string">"onclick"</span>] = AddNewObserver;</div><div class="line"></div><div class="line"><span class="comment">// 具体的观察者</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">AddNewObserver</span>(<span class="params"></span>)</span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">//建立一个新的用于增加的checkbox</span></div><div class="line">  <span class="keyword">var</span> check  = <span class="built_in">document</span>.createElement( <span class="string">"input"</span> );</div><div class="line">  check.type = <span class="string">"checkbox"</span>;</div><div class="line"></div><div class="line">  <span class="comment">// 使用Observer 类扩展checkbox</span></div><div class="line">  extend( <span class="keyword">new</span> Observer(), check );</div><div class="line"></div><div class="line">  <span class="comment">// 使用定制的Update函数重载</span></div><div class="line">  check.Update = <span class="function"><span class="keyword">function</span>(<span class="params"> value </span>)</span>&#123;</div><div class="line">    <span class="keyword">this</span>.checked = value;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// 增加新的观察者到我们主要的被观察者的观察者列表中</span></div><div class="line">  controlCheckbox.AddObserver( check );</div><div class="line"></div><div class="line">  <span class="comment">// 将元素添加到容器的最后</span></div><div class="line">  container.appendChild( check );</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在这个例子里面，我们看到了如何实现和配置观察者模式，了解了被观察者，观察者，具体被观察者，具体观察者的概念。</p>
<p><strong>观察者模式和发布/订阅模式的不同</strong><br>观察者模式确实有用，但是在javaScript世界里面，通常我们使用一种叫做发布/订阅模式的变体来实现观察者模式。这两种模式很相似，但是也有一些值得注意的不同。</p>
<p>观察者模式要求想要接收相关通知的观察者必须到发起这个事件的被观察者上注册这个事件。</p>
<p>发布/订阅模式使用一个主题/事件频道，这个频道处于想要获取通知的订阅者和发起事件的发布者之间。这个事件系统允许代码定义应用相关的事件，这个事件可以传递特殊的参数，参数中包含有订阅者所需要的值。这种想法是为了避免订阅者和发布者之间的依赖性。</p>
<p>这种和观察者模式之间的不同，使订阅者可以实现一个合适的事件处理函数，用于注册和接受由发布者广播的相关通知。</p>
<p>这里给出一个关于如何使用发布者/订阅者模式的例子，这个例子中完整地实现了功能强大的publish(), subscribe() 和 unsubscribe()。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//一个非常简单的邮件处理器</span></div><div class="line"><span class="comment">//接受的消息的计数器</span></div><div class="line"><span class="keyword">var</span> mailCounter = <span class="number">0</span>;</div><div class="line"></div><div class="line"><span class="comment">//初始化一个订阅者，这个订阅者监听名叫"indox/newMessage"的频道</span></div><div class="line"></div><div class="line"><span class="comment">//渲染新消息的粗略信息</span></div><div class="line"><span class="keyword">var</span> subscribe1 = subscribe(<span class="string">"inbox/newMessage"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">topic,data</span>)</span>&#123;</div><div class="line">  <span class="comment">//日志记录主题，用于调试</span></div><div class="line">  <span class="built_in">console</span>.log(<span class="string">"A new message was received: "</span>, topic);</div><div class="line"></div><div class="line">  <span class="comment">//使用来自于被观察者的数据，用于给用户展示一个消息的粗略信息</span></div><div class="line">  $(<span class="string">".messageSender"</span>).html(data.sender);</div><div class="line">  $(<span class="string">".messagePriview"</span>).html(data.body);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">//这是另外一个订阅者，使用相同的数据执行不同的任务</span></div><div class="line"><span class="comment">//更新计数器，显示当前来自于发布者的新信息的数量</span></div><div class="line"><span class="keyword">var</span> subscribe2 = subscribe(<span class="string">"inbox/newMessage"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">topic,data</span>)</span>&#123;</div><div class="line">  $(<span class="string">".newMessageCounter"</span>).html(mailCounter++);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">publish(<span class="string">"inbox/newMessage"</span>,[&#123;</div><div class="line">  <span class="attr">sender</span>: <span class="string">"hello@ceair.com"</span>,</div><div class="line">  <span class="attr">body</span>: <span class="string">"Hello world!"</span></div><div class="line">&#125;]);</div><div class="line"></div><div class="line"><span class="comment">//在之后，我们可以让我们的订阅者通过下面的方式取消订阅来自于新主题的通知</span></div><div class="line"><span class="comment">//unsubscribe(subscribe1);</span></div><div class="line"><span class="comment">//unsubscribe(subscribe2);</span></div></pre></td></tr></table></figure></p>
<p>这个例子的更广的意义是对松耦合的原则的一种推崇。不是一个对象直接调用另外一个对象的方法，而是通过订阅另外一个对象的一个特定的任务或者活动，从而在这个任务或者活动出现的时候得到通知。</p>
<p><strong>优势</strong><br>观察者和发布/订阅模式鼓励人们认真考虑应用不同部分之间的关系，同时帮助我们找出这样的层，该层中包含有直接的关系，这些关系可以通过一系列的观察者和被观察者来替换掉。这种方式可以有效地将一个应用程序切割成小块，这些小块耦合度低，从而改善代码的管理，以及用于潜在的代码复用。</p>
<p>使用观察者模式更深层次的动机是，当我们需要维护相关对象的一致性的时候，我们可以避免对象之间的紧密耦合。例如，一个对象可以通知另外一个对象，而不需要知道这个对象的信息。</p>
<p>两种模式下，观察者和被观察者之间都可以存在动态关系。这提供很好的灵活性，而当我们的应用中不同的部分之间紧密耦合的时候，是很难实现这种灵活性的。</p>
<p>尽管这些模式并不是万能的灵丹妙药，这些模式仍然是作为最好的设计松耦合系统的工具之一，因此在任何的JavaScript开发者的工具箱里面，都应该有这样一个重要的工具。</p>
<p><strong>缺点</strong><br>事实上，这些模式的一些问题实际上正是来自于它们所带来的一些好处。在发布/订阅模式中，将发布者共订阅者上解耦，将会在一些情况下，导致很难确保我们应用中的特定部分按照我们预期的那样正常工作。</p>
<p>例如，发布者可以假设有一个或者多个订阅者正在监听他们。比如我们基于这样的假设，在某些应用处理过程中来记录或者输出错误日志。如果订阅者执行日志功能崩溃了，因为系统本身的解耦本质，发布者没有办法感知到这些事情。</p>
<p>另外一个这种模式的缺点是，订阅者对彼此之间存在没有感知，对切换发布者的代价无从得知。因为订阅者和发布者之间的动态关系，更新依赖也很难去追踪。</p>
<p><strong>发布/订阅实现</strong><br>发布/订阅在JavaScript的生态系统中非常合适，主要是因为作为核心的ECMAScript实现是事件驱动的。尤其是在浏览器环境下更是如此，因为DOM使用事件作为其主要的用于脚本的交互API。</p>
<p>也就是说，无论是ECMAScript还是DOM都没有在实现代码中提供核心对象或者方法用于创建定制的事件系统。</p>
<p>幸运的是，流行的JavaScript库例如dojo, jQuery(定制事件)以及YUI已经有相关的工具，可以帮助我们方便的实现一个发布/订阅者系统。下面我们看一些例子。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 发布</span></div><div class="line"></div><div class="line"><span class="comment">// jQuery: $(obj).trigger("channel", [arg1, arg2, arg3]);</span></div><div class="line">$( el ).trigger( <span class="string">"/login"</span>, [&#123;<span class="attr">username</span>:<span class="string">"test"</span>, <span class="attr">userData</span>:<span class="string">"test"</span>&#125;] );</div><div class="line"></div><div class="line"><span class="comment">// Dojo: dojo.publish("channel", [arg1, arg2, arg3] );</span></div><div class="line">dojo.publish( <span class="string">"/login"</span>, [&#123;<span class="attr">username</span>:<span class="string">"test"</span>, <span class="attr">userData</span>:<span class="string">"test"</span>&#125;] );</div><div class="line"></div><div class="line"><span class="comment">// YUI: el.publish("channel", [arg1, arg2, arg3]);</span></div><div class="line">el.publish( <span class="string">"/login"</span>, &#123;<span class="attr">username</span>:<span class="string">"test"</span>, <span class="attr">userData</span>:<span class="string">"test"</span>&#125; );</div><div class="line"></div><div class="line"><span class="comment">// 订阅</span></div><div class="line"></div><div class="line"><span class="comment">// jQuery: $(obj).on( "channel", [data], fn );</span></div><div class="line">$( el ).on( <span class="string">"/login"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> event </span>)</span>&#123;...&#125; );</div><div class="line"></div><div class="line"><span class="comment">// Dojo: dojo.subscribe( "channel", fn);</span></div><div class="line"><span class="keyword">var</span> handle = dojo.subscribe( <span class="string">"/login"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>)</span>&#123;..&#125; );</div><div class="line"></div><div class="line"><span class="comment">// YUI: el.on("channel", handler);</span></div><div class="line">el.on( <span class="string">"/login"</span>, <span class="function"><span class="keyword">function</span>(<span class="params"> data </span>)</span>&#123;...&#125; );</div><div class="line"></div><div class="line"><span class="comment">// 取消订阅</span></div><div class="line"></div><div class="line"><span class="comment">// jQuery: $(obj).off( "channel" );</span></div><div class="line">$( el ).off( <span class="string">"/login"</span> );</div><div class="line"></div><div class="line"><span class="comment">// Dojo: dojo.unsubscribe( handle );</span></div><div class="line">dojo.unsubscribe( handle );</div><div class="line"></div><div class="line"><span class="comment">// YUI: el.detach("channel");</span></div><div class="line">el.detach( <span class="string">"/login"</span> );</div></pre></td></tr></table></figure></p>
<p>尤其对于jQuery 开发者来讲，他们拥有很多其它的选择，可以选择大量的良好实现的代码，从Peter Higgins 的jQuery插件到Ben Alman 在GitHub 上的（优化的）发布/订阅 jQuery gist。下面给出了这些代码的链接。</p>
<ul>
<li><a href="https://gist.github.com/661855" target="_blank" rel="external">Ben Alman的发布/订阅 gist(推荐)</a></li>
<li><a href="https://gist.github.com/705311" target="_blank" rel="external">Rick Waldron 在上面基础上修改的 jQuery-core 风格的实现</a></li>
<li><a href="http://github.com/phiggins42/bloody-jquery-plugins/blob/master/pubsub.js" target="_blank" rel="external">Peter Higgins 的插件</a></li>
<li><a href="http://amplifyjs.com/" target="_blank" rel="external">AppendTo 在AmplifyJS中的 发布/订阅实现</a></li>
<li><a href="https://gist.github.com/826794" target="_blank" rel="external">Ben Truyman的 gist</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="GaoQ" />
          <p class="site-author-name" itemprop="name">GaoQ</p>
          <p class="site-description motion-element" itemprop="description">There are no shortcuts to any place worth going</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">39</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">GaoQ</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"gaoquan"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  


</body>
</html>
