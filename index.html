<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css"/>




  <link href="//fonts.googleapis.com/css?family=Lato:300,400,700,400italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">



<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=0.5.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="GaoQ's blog" />





  <link rel="alternate" href="/atom.xml" title="GaoQ's blog" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=0.5.0" />






<meta name="description" content="There are no shortcuts to any place worth going">
<meta property="og:type" content="website">
<meta property="og:title" content="GaoQ&#39;s blog">
<meta property="og:url" content="http://gaoquan.wang/index.html">
<meta property="og:site_name" content="GaoQ&#39;s blog">
<meta property="og:description" content="There are no shortcuts to any place worth going">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="GaoQ&#39;s blog">
<meta name="twitter:description" content="There are no shortcuts to any place worth going">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> GaoQ's blog - There are no shortcuts to any place worth going </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?b902fa08b28044c55da6c70921955ecb";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>


<a href="https://github.com/GaoQ1"><img style="position: absolute; top: 0; left: 0; border: 0;" src="https://camo.githubusercontent.com/8b6b8ccc6da3aa5722903da7b58eb5ab1081adee/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f6c6566745f6f72616e67655f6666373630302e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_left_orange_ff7600.png"></a>


    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">GaoQ's blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">There are no shortcuts to any place worth going</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
            关于我
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/06/04/测试下/" itemprop="url">
                  测试下
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-06-04T20:59:33+08:00" content="2017-06-04">
              2017-06-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/06/04/测试下/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/06/04/测试下/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="你好"><a href="#你好" class="headerlink" title="你好"></a>你好</h2>
          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/10/26/live-server和http-server/" itemprop="url">
                  live-server和http-server
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-10-26T11:04:05+08:00" content="2016-10-26">
              2016-10-26
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/教程/" itemprop="url" rel="index">
                    <span itemprop="name">教程</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/10/26/live-server和http-server/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/10/26/live-server和http-server/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>I find that the harder I work, the more luck I seem to have.</p>
</blockquote>
<h2 id="概括"><a href="#概括" class="headerlink" title="概括"></a>概括</h2><p>前端开发的过程中，总有这样的需求。想快速在移动端，PC端看看页面的效果，看看交互的效果。通常我们会自己搭建一个服务器，或简单或复杂。<br>这里推荐的两个live-server和http-server是基于nodejs的快速搭建服务器的插件。</p>
<h2 id="开始使用"><a href="#开始使用" class="headerlink" title="开始使用"></a>开始使用</h2><p>当然首先在用这两个live-server和http-server的前提是你要安装nodejs。<br>然后起个terminal窗口，全局安装live-server和http-server。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">npm install -g live-server</div><div class="line">npm install -g http-server</div></pre></td></tr></table></figure></p>
<p>安装完毕后，你就可以在你需要其服务的目录下直接输入<code>live-server</code>或者<code>http-server</code></p>
<h2 id="live-server和http-server的区别"><a href="#live-server和http-server的区别" class="headerlink" title="live-server和http-server的区别"></a><a href="https://github.com/tapio/live-server" target="_blank" rel="external">live-server</a>和<a href="https://github.com/indexzero/http-server" target="_blank" rel="external">http-server</a>的区别</h2><p><code>live-server</code>提供的功能是：</p>
<ol>
<li>由于安全限制，AJAX的请求不能是<code>file://</code>的协议。因此你需要创建一个server来调用AJAX请求</li>
<li><code>live-server</code>另一个用途是，当所要监控的文件发生变化，页面会自动刷新，且十分方便简单。</li>
</ol>
<p><code>http-server</code>功能就略微单一，只是一个简单的无须配置的http服务器。</p>
<h2 id="live-server和http-server的命令行的使用"><a href="#live-server和http-server的命令行的使用" class="headerlink" title="live-server和http-server的命令行的使用"></a>live-server和http-server的命令行的使用</h2><p>关于live-server和http-server命令行的使用，比如如何设置port、host等等，具体的请查看对应的github进行查看。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/31/CSS_3D_Panorama/" itemprop="url">
                  CSS_3D_Panorama
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-31T10:37:01+08:00" content="2016-08-31">
              2016-08-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/转载笔记/" itemprop="url" rel="index">
                    <span itemprop="name">转载笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/31/CSS_3D_Panorama/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/31/CSS_3D_Panorama/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Tomorrow is never clear.Our time is here.</p>
</blockquote>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>3D全景并不是什么新鲜事物了，但以前我们在Web上看到的3D全景一般是通过flash实现的。若我们能将CSS3 Transform的相关知识运用得当，也是能实现类似的效果。换句话说，3D全景其实就是CSS3 3D的应用场景之一。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>在实现CSS3 3D全景之前，我们先理清部分CSS3 Transform属性：</p>
<ul>
<li>Transform-origin: 元素变形的原点（默认值为 50% 50% 0，该数值和后续提及的百分比均默认基于元素自身的宽高算出具体数值）;</li>
<li>perspective: 指定了观察者与z=0平面的距离，使具有三维位置变换的元素产生透视效果（默认值：none，值只能是绝对长度，即负数是非法值）;</li>
<li>transform-style: 用于指定其为子元素提供2D还是3D的场景。另外，该属性是非继承的。</li>
<li>transform: 该属性能让你修改CSS可视化模型的坐标空间，其中包括平移(translate)、旋转(rotate)、缩放(scale)和扭曲(skew).</li>
</ul>
<p>下面对上述的一些点进行更深入的分析：</p>
<ul>
<li>perspective，该属性指定了“眼睛”与元素的<code>perspective-origin</code>(默认值为50% 50%)点的距离。那么问题来了：“当我们应用px作为衡量单位时，那它的实际距离该如何量化呢（即如何得到我们熟悉且易于表达的距离）?”  当我们的屏幕的分辨率是1080p(1920*1080px)，且该元素或祖先元素的perspective值为1920px时，该应用了CSS3 3D Transform的元素的立体效果就相当于我们我们在一个屏幕宽度(1920px)的屏幕前观看该元素的真是效果。尽管如此，目前我也不清楚如何准确地为元素设置一个合适的perspective的值，只能猜测个大概值，然后再动态修改值，以达到满意的呈现效果。<br><img src="/images/CSS3D/perspective.jpg" alt="呈现效果"><br>根据相似三角形的性质可计算出被前移的元素最终在屏幕上显示的实际大小</li>
</ul>
<p>另外，关于perspective还有另外一个重要的点。因为，<code>perspective-origin</code>的默认值为50% 50%,因此对哪个元素应用perspective属性，就决定了“眼睛”的位置(即我们的“眼睛”是在哪个角度看物体)。一般来说，当我们需要正视物体时，就会将该属性设置在与 <strong>该元素中心重合的某一祖先元素上</strong>。</p>
<p>再另外，如果说“如何让一个元素(背面)不可见?”，你可能会说backface-visibility:hidden。其实，对于在“眼睛”背后的元素(以元素的<code>transform-origin</code>为参考点)， <strong>即元素的z轴坐标值大于perspective的值，浏览器是不会将其渲染出来的</strong>。</p>
<ul>
<li>对于<code>transform-style</code>，该属性指定了其子元素是处于3D场景还是2D场景。对于2D场景，元素的前后位置是按照平时的渲染方式(即若在普通文档流中，是按照代码中元素的先后顺序，后面的元素会遮住在其前面的元素)；对于3D场景，元素的前后位置是按照真实世界的规则排序(即越靠近“眼睛”的，会遮住离“眼睛”更远的元素)。 另外，由于 <strong>transform-style属性是非继承性的，对于中间节点需要显示设定</strong></li>
<li>对于transform属性：下图整理了rotate3d、translate3d的变化方向：<br><img src="/images/CSS3D/transform.jpg" alt="变换方向"><br>transform中的变换属性的顺序是有关系的，如transformX(10px)rotate(30deg)与rotate(30deg)transformX(10px)是不等价的。</li>
</ul>
<p>另外，需要注意的是scale中如果有负数值，则该方向会产生180度的翻转。再另外，部分transform效果会导致元素(字体)模糊，如translate的数值存在小数、通过translateZ或scale方法元素等等。每个浏览器都有其不同的表现。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>上面理清了一些CSS Transform的知识点，下面就讲讲如何实现CSS 3D全景：</p>
<p>想象一下，当我们站在十字路口中间，身体不动，头部旋转 360°，这个过程中所看到的画面就形成了一幅以你为中心的全景图了。其实，当焦距不变时，我们就等同于站在一个圆柱体的中心。</p>
<p>但是，虚拟世界与现实的最大不同是：没有东西是连续的，即所有东西都是离散的。例如，你无法在屏幕上显示一个完美的圆。你只能以一个正多边形表示圆：边越多，圆就越“完美”。</p>
<p>同理，在三维空间，每个 3D 模型都等同于一个多面体（即 3D 模型只能由不弯曲的平面组成）。当我们讨论一个本身就是多面体（如立方体）的模型时并不足以为奇，但当我们想展示其它模型时，如球体时，就需要记住这个原理了。<br><img src="/images/CSS3D/ball.png" alt="球体模型"></p>
<p><a href="http://zwj360.im20.com.cn/" target="_blank" rel="external">淘宝造物节的活动页</a>就是CSS 3D全景的一个很赞的页面，它将全景图分隔成20等份，相邻的元素间差18deg(360/20)。需要注意的是：我们要确保每个元素的正面是指向圆柱中心的，所以要计算好每等份的旋转角度值。然后再将元素向外(即Z轴方向)平移r px.对于立方体r就是边长/2，而对于其他更复杂的正多面体呢？</p>
<p>举例：对于正九面体，每个元素的宽为210px，对应的角度为40deg，例如下图：<br><img src="/images/CSS3D/diagram.png" alt="正九面体的俯视图"><br><img src="/images/CSS3D/calc.png" alt="计算过程"></p>
<p>由此得到一个公用函数，只需传入含有元素的宽度和元素数量的对象，即可得到r值：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">calTranslateZ</span>(<span class="params">opts</span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="built_in">Math</span>.round(opts.width/(<span class="number">2</span>*<span class="built_in">Math</span>.tan(<span class="built_in">Math</span>.PI/opts.number)))</div><div class="line">&#125;</div><div class="line"></div><div class="line">calTranslateZ(&#123;</div><div class="line">  <span class="attr">width</span>: <span class="number">210</span>,</div><div class="line">  <span class="attr">number</span>: <span class="number">9</span></div><div class="line">&#125;)</div></pre></td></tr></table></figure></p>
<p><img src="/images/CSS3D/expand4.gif" alt="俯视时所看到的元素外移动画"></p>
<p>另外，为了让下文易于理解，我们约定html结构是：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#view(perspective:1000px)</div><div class="line">  #stage(transform-style: perserve-3d)</div><div class="line">    #cube(transform-style: perserve-3d)</div><div class="line">      .div(width:600px;height:600px) /*组成立方体的元素*/</div></pre></td></tr></table></figure></p>
<p>正多面体构建完成后，就需要将我们的“眼睛”放置在正多面体内。由于在“眼睛”后的元素是不会被浏览器所渲染的（与 .div元素 是否设置 backface-visibility:hidden; 无关），且我们保证了.div元素的正面都指向了正多面体的中心，这就形成360deg被环绕的效果了。<br>那“眼睛”具体是被放置在哪个位置？<br>答：通过设置#stage元素的translateZ的值，让不能被看到的.div元素的Z轴坐标值大于perspective的值即可。如：立方体的正面的translateZ是-300px(为了保证立方体的正面是指向立方体中心，正面元素需要设置rotate(-180deg) translateZ(-300px), 即正面元素向“眼球”方向平移了300px),而#view的perspective的值为1000px，那么 #stage 的 translateZ 的值应该大于 700px 且小于 1300px，具体数值则取决于你想要呈现的效果了。</p>
<p>可由下图看出，将水平的 4 张图片合成后就是一张全景图：<br><img src="/images/CSS3D/panorama3d.jpg" alt="4张图合成的全景图"></p>
<p>理解上述知识后，就可以通过为元素设置合适的 CSS3 Transform 属性值，即可实现一张可交互的全景图了。当然，交互的效果可以是拖拽，也可以是重力感应等。</p>
<p>正如在上文提到的：“没有东西是连续的，即所有东西都是离散的…”。将《造物节》与后续全景图的水平方向上的图片分别合成一张图后，可以发现：图片数量越多，图片的要求也越低。你觉得呢？<br><img src="/images/CSS3D/zaowujie.jpg" alt="造物节全景图"></p>
<h2 id="全景图素材的制作"><a href="#全景图素材的制作" class="headerlink" title="全景图素材的制作"></a>全景图素材的制作</h2><p>将全景图制作分为设计类与实景类：</p>
<h3 id="设计类"><a href="#设计类" class="headerlink" title="设计类"></a>设计类</h3><p>要制作类似 <a href="http://zwj360.im20.com.cn/" target="_blank" rel="external">《淘宝造物节》</a> 的全景页面，设计稿需要有以下这些要求。</p>
<p>整体背景设计图如下（2580*1170px，被分成 20 等份）：<br><img src="/images/CSS3D/zaowujie.jpg" alt="造物节全景图"></p>
<p>基本要求：</p>
<ul>
<li>水平方向上需要首尾相连；</li>
<li>因为效果图最终需要切成 N 等份，所以尽可能让 设计图的宽度能被 N 整除；</li>
<li>图片尺寸不仅要考虑正视图的大小，还要考虑元素在旋转时依然能覆盖视野（可选）。</li>
</ul>
<p>当然，上图只是背景图，还可以添加一些小物体素材（通过运动速度的差异形成视差，增强立体效果），如：<br><img src="/images/CSS3D/item3.jpg" alt="小物体元素1"><br><img src="/images/CSS3D/item1.jpg" alt="小物体元素2"></p>
<p>小物体元素（虚线是用于参考的，造物节中共有 21 个小物体）</p>
<p>如上图所示，每个图片也是被等分成 M 等份。当然，M 取决于物体在背景上的具体位置和本身大小。<br>另外，M 的宽度是与 N 的宽度相等的。尽管部分物体（M&gt;1）的两侧等份的图案占比小，但建议保留同样的宽度。</p>
<p>注：如果小物体有特殊的变形效果，应该备注具体变形参数。</p>
<p>对于顶部和底图图片，则无特殊要求。</p>
<h3 id="实景类"><a href="#实景类" class="headerlink" title="实景类"></a>实景类</h3><p>如果想制作实景的全景，可以看看 Google 街景：<br><a href="https://www.google.com/streetview/publish/" target="_blank" rel="external">Google街景</a>推荐的设备如下：<br><img src="/images/CSS3D/panorama_machine.jpg" alt="实景类工具"></p>
<p>处理全景的方式：</p>
<ul>
<li>利用 RICOH THETA S 等专业设备拍出全景图</li>
<li>导出静态图像</li>
<li>利用设备专门提供的 APP 或 krpamo tools、pano2vr、Glsky box 等工具将静态图像转为6张图</li>
<li>利用 Web 技术制作可交互的全景图</li>
</ul>
<p>其中 Web 技术有以下3种可选方式（当然，还有其它）：</p>
<ul>
<li>CSS3（本文所提及的方式）</li>
<li>Three.js</li>
<li>krpano（为全景而生，低级浏览器则回退到 Flash），<a href="http://krpano.com/docu/tutorials/quickstart/?from=groupmessage&amp;isappinstalled=0#top" target="_blank" rel="external">查看教程</a></li>
</ul>
<p>可见，优秀硬件设备的出现，大大减少了后期处理的时间，而 Web 则提供了一个很好的展现平台。</p>
<h2 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h2><p>随着终端设备的软硬件不断完善和提高，Web 在 3D 领域也不甘落后，如果你玩腻了 2D 的 H5 或者想为用户提供更加新颖优秀的体验，全景也许是一种选择。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/28/如何运用最新的技术提升网页速度和性能/" itemprop="url">
                  如何运用最新的技术提升网页速度和性能
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-28T14:50:27+08:00" content="2016-08-28">
              2016-08-28
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/转载笔记/" itemprop="url" rel="index">
                    <span itemprop="name">转载笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/28/如何运用最新的技术提升网页速度和性能/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/28/如何运用最新的技术提升网页速度和性能/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>What doesn’t kill you makes you stronger.</p>
</blockquote>
<h2 id="性能设计"><a href="#性能设计" class="headerlink" title="性能设计"></a>性能设计</h2><p>在我们的项目中，我们每天都会和设计师和产品负责人讨论关于平衡美观和性能的问题。对于我们自己的网站，这样做是很简单的。简言之，我们认为好的用户体验从快速的内容传输开始，也就是意味着性能&gt;美观。</p>
<p>好的内容、布局、图片和交互是吸引用户的重要因素。这每个因素都会影响页面的加载时间和终端用户体验。每一步我们都在探讨如何在获得好的用户体验和保证设计美感的同时，最小化对性能的影响。</p>
<h2 id="内容优先"><a href="#内容优先" class="headerlink" title="内容优先"></a>内容优先</h2><p>我们想要把核心内容尽快呈现给用户，意味着我们要处理好基本的HTML和CSS。每个页面都应该达到基本的目的：传递信息。JS、CSS、网页字体、图片、网站分析等优化都是位居于核心内容之下的。</p>
<h2 id="可控性"><a href="#可控性" class="headerlink" title="可控性"></a>可控性</h2><p>给理想网站定义了标准后，我们总结出：想要达到预期效果，就要能对网站各方面的控制都游刃有余。我们选择构建自己的静态站点生成器，包括资源传输，并且由我们自己操控。</p>
<h2 id="静态站点生成器"><a href="#静态站点生成器" class="headerlink" title="静态站点生成器"></a>静态站点生成器</h2><p>我们用nodejs实现了静态站点生成器。它是采用带有简短JSON页面描述标签的Markdown文件来生成整个网站结构和它所有的资源。为了包括特殊的脚本页面，也可以附带一个HTML文件。以下是一个简单化的描述标签和markdown文件，用于博客的发布，用它来生成真正的HTML.</p>
<p>JSON描述标签：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="string">"keywords"</span>: [<span class="string">"performance"</span>, <span class="string">"critical rendering path"</span>, <span class="string">"static site"</span>],</div><div class="line"><span class="string">"publishDate"</span>: <span class="string">"2016-08-28"</span>,</div><div class="line"><span class="string">"authors"</span>: [<span class="string">"Co"</span>]</div></pre></td></tr></table></figure></p>
<p>markdown文件：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># Title</div><div class="line">## Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</div></pre></td></tr></table></figure></p>
<h2 id="图片传输"><a href="#图片传输" class="headerlink" title="图片传输"></a>图片传输</h2><p>平均一个2406kb的网页中1535kb是图片。就因为图片在网站中占据了这么大一个比例，所以它也是性能优化的重点之一。</p>
<h2 id="Webp格式"><a href="#Webp格式" class="headerlink" title="Webp格式"></a>Webp格式</h2><p>Webp是一种现在图片格式，为网页图片提供了出色的低损耗、有损压缩。Webp格式的图片实质上比其他格式的小，有时可以比同样的JPEG图片小25%。Webp被大多数人所忽略，也没有被经常使用。截止到写这篇文章的时候，Webp仅支持Chrome、Opera和Android(仍超过我们50%的用户)，但我们可以优雅降级为JPG/PNG。</p>
<p>使用<picture>元素我们可以把图片从Webp优雅地降级到其他被广发支持的图片格式，如JPEG：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;picture&gt;</div><div class="line">  &lt;source type="image/webp" srcset="image-1.webp" media="(min-width: 640px)"&gt;</div><div class="line">  &lt;source type="image/webp" srcset="image-m.webp" media="(min-width: 320px)"&gt;</div><div class="line">  &lt;source type="image/webp" srcset="image-s.webp"&gt;</div><div class="line">  &lt;source srcset="image-1.jpg" media="(min-width: 640px)"&gt;</div><div class="line">  &lt;source srcset="image-m.jpg" media="(min-width: 320px)"&gt;</div><div class="line">  &lt;source srcset="image-s.jpg"&gt;</div><div class="line">  &lt;img alt="Description of the image" src="image-1.jpg"&gt;</div><div class="line">&lt;/picture&gt;</div></pre></td></tr></table></figure></picture></p>
<p>我们使用Scott Jehl 的picturefill来使那些不支持<picture>元素的浏览器获得支持，在各个浏览器中达到一致的效果。</picture></p>
<p>我们使用<img>作为那些不支持<picture>或者JS的浏览器的后备元素。使用图片的最大实例确保了它在后备方案中的可行性。</picture></p>
<h2 id="生成"><a href="#生成" class="headerlink" title="生成"></a>生成</h2><p>尽管图片传输方式已经确定了，我们仍需要思考怎样有效执行。我喜欢<picture>元素的功能，但不喜欢上面那些代码段，尤其是写内容是必须把它加进去。我们不想做这么费力的事情：每张图片都要写6个实例，所以优化这些图片并且把它们写在markdown文件的<picture>里面。所以：</picture></picture></p>
<h2 id="生成图片"><a href="#生成图片" class="headerlink" title="生成图片"></a>生成图片</h2><p>在构建过程中，原图片的多个实例，包括JPG、PNG和Webp格式，我们使用gulp responsive来生成。</p>
<h2 id="最小化图片"><a href="#最小化图片" class="headerlink" title="最小化图片"></a>最小化图片</h2><p>在markdown文件中写图片描述(image.jpg).</p>
<p>在构建过程中使用自定义markdown渲染器来为已经完全成熟的<picture>元素编译传统的markdown图片声明。</picture></p>
<h2 id="SVG动画"><a href="#SVG动画" class="headerlink" title="SVG动画"></a>SVG动画</h2><p>我们为自己的网站选择了特定的图表类型，其中SVG插图占了主要地位。这样做有以下几个原因：首先，SVG的图片比位图更小；其二，SVG图片本身就是响应式的，有很棒的伸缩性，所以不需要图片生成及<picture>元素；最后一点也是很重要的一点，就是我们可以通过CSS来不断改变它，赋予它新的活力！我们所有的组合页面都有一个自定义的动态SVG图，可以被概述页面所复用。这张图片作为我们所有的组合页面中的一种循环风格，使得页面设计一体化，同时又几乎不会对性能造成影响。请看这张动画，看看我们是如何用CSS来改变它的。<br><img src="/images/SEO/0.gif" alt="例子"></picture></p>
<h2 id="自定义网页字体"><a href="#自定义网页字体" class="headerlink" title="自定义网页字体"></a>自定义网页字体</h2><p>在深入之前，这里有一个关于在浏览器设置自定义字体的简短介绍。当浏览器发现CSS里面有@font-face的定义，但是用户的电脑并不支持该字体时，它会尝试下载该字体文件。在下载时，多数浏览器根本不会用这种字体来展示文本。这种现象称为“不可见文本的闪现”或者FOIT.如果你有留意，你会发现网页上都有这种情况存在。如果你问我，我会告诉你这会影响用户体验。它延迟了用户读取他们所需内容的时间。我们可以迫使浏览器改变这种行为，变成“无样式内容闪现”或者称为FOUT。我们告诉浏览器先使用普通字体，想Arial或者Georgia。当自定义的字体下载完成后，再代替标准字体并且重新渲染。这样，即使自定义字体只是一种优化。尽管没有自定义字体，网页看起来也完好，也能百分百的正常运行。勾选/不勾选复选框来切换我们的网页字体，来自己体验一下：<br>切换下载的字体类使用自定义网页字体可以改善我们的用户体验，只要你能够优化他们，并且负责任地为之服务。</p>
<h2 id="字型子集设定"><a href="#字型子集设定" class="headerlink" title="字型子集设定"></a>字型子集设定</h2><p>到目前为止，子集设定以最短的时间在改善网页字体性能方面取胜。我将会向每个使用自定义字体的网页开发者推荐子集设定。如果你能完全控制网页内容，并且知道它将要展示哪些特性的话，你可以完全使用子集设定。但是，即使是仅仅把字体设为西方语言，也会对文件大小造成很大的影响。例如，我们的Noto Regular WOFF 字体，默认是246KB，将其设为西方语言后，大小下降到31KB。我们使用Font squirrel webfont，这种字体真的很易用。</p>
<h2 id="字体监听器"><a href="#字体监听器" class="headerlink" title="字体监听器"></a>字体监听器</h2><p>Bram Stein推出的字体监听器是一个很了不起的脚本，可以帮助检查字体是否已被加载。至于你是如何加载字体的，是通过一个网页字体服务，还是自己上传就不可知了。在这个监听器告诉我们所有自定义的字体已经下载完毕后，我们就可以在<html>元素上添加一个字体加载完毕的类，我们的页面就会重新用心的字体：<br><figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">html</span>&#123;</div><div class="line">  <span class="attribute">font-family</span>: Georgia, serif;</div><div class="line">&#125;</div><div class="line"><span class="selector-tag">html</span><span class="selector-class">.fonts-loaded</span>&#123;</div><div class="line">  <span class="attribute">font-family</span>: Noto, Georgia, serif;</div><div class="line">&#125;</div></pre></td></tr></table></figure></html></p>
<p>注意：为了简短，我们有给上面的CSS中的Noto加上@font-face的声明。</p>
<p>我们可以设定一个cookie来记住所有的字体已经被加载过，就可以让他们缓存在浏览器里面了。我们使用这个cookie来替代重复的视图，这个我后续会解释。</p>
<p>在不久的将来，我们或许不需要Bram Stein的脚本来监听这个行为。CSS开发团队已经提案一个新的@font-face描述器，也叫font-display。它的属性值控制着一个可下载的字体是如何在还没加载出来时就渲染页面的。这是CSS对font-display的描述：它将带给我们像上面方法一样的行为效果。你可以读读更多关于font-display的属性。</p>
<h2 id="JS和CSS懒加载"><a href="#JS和CSS懒加载" class="headerlink" title="JS和CSS懒加载"></a>JS和CSS懒加载</h2><p>一般来讲，我们都是尽可能快的加载需要的资源。我们移除一些堵塞的请求来加快页面渲染，优化首屏，用浏览器缓存来处理重复的页面。</p>
<h3 id="JS懒加载"><a href="#JS懒加载" class="headerlink" title="JS懒加载"></a>JS懒加载</h3><p>设计上，我们的网站并没有很多JS。我们发展了一个javascript工作流来处理我们目前已有的js，以及未来会用到的js资源。</p>
<p>JS在<head>块里面渲染，这是我们想要的。JS应该只是用来提高用户体验，不应该是访问者需要的关键。处理JS堵塞渲染的简单方法就是把脚本放在页面的尾部。这样网页就会在真个HTML渲染完毕后才去加载JS。</head></p>
<p>另一种可以把脚本放在head执行的方案就是在<code>&lt;script&gt;</code>标签里面添加defer属性，来延迟脚本的执行。由于浏览器下载脚本是很快的，不会堵塞页面渲染进程，等到页面完全加载完，才会执行脚本里面的代码。还有一件事，我们没有使用像jQuery这些库，所以我们的脚本取决于vanilla脚本的特性。我们只是想要在浏览器加载脚本来支持这些特性。最终的结果就像下面的代码这样：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&lt;script&gt;</div><div class="line"><span class="keyword">if</span>(<span class="string">'querySelector'</span> <span class="keyword">in</span> <span class="built_in">document</span> &amp;&amp; <span class="string">'addEventListener'</span> <span class="keyword">in</span> <span class="built_in">window</span>)&#123;</div><div class="line">  <span class="built_in">document</span>.write(<span class="string">'&lt;script src="index.js" defer&gt;&lt;/script&gt;'</span>);</div><div class="line">&#125;</div><div class="line">&lt;<span class="regexp">/script&gt;</span></div></pre></td></tr></table></figure></p>
<p>我们把这小段脚本放在页面头部，来检测浏览器是否支持vanilla javascript的document.querySelector和window.addEventListener属性。如果支持，我们通过<code>&lt;script&gt;</code>标签直接给页面加载脚本，并使用defer属性让它不会堵塞页面渲染。</p>
<h3 id="懒加载CSS"><a href="#懒加载CSS" class="headerlink" title="懒加载CSS"></a>懒加载CSS</h3><p>对于首屏来讲，网站最大的渲染堵塞资源就是CSS了。只有当<code>&lt;head&gt;</code>里面的CSS文件完全加载完毕时，浏览器才会开始渲染页面。这种做法是经过深思熟虑的，若不是这样，浏览器就需要在整个渲染过程中不断重新计算布局尺寸，不断重绘。</p>
<p>为了防止CSS堵塞渲染，我们就需要异步加载CSS文件。我们使用了Filament Group的awesome loadCSS函数。该函数提供了一个回调，当CSS文件加载完后，我们设置一个cookie来声明CSS文件已经加载了。我们使用这个cookie来重现页面，这一点我后续会解释到。</p>
<p>CSS异步加载也带来这样一个问题，尽管HTML真的很快被渲染出来，但看起来只有纯粹的HTML，只有等到这个CSS文件加载完且停止时，才会有样式。这时就要提到关键CSS了。</p>
<h3 id="关键部分CSS"><a href="#关键部分CSS" class="headerlink" title="关键部分CSS"></a>关键部分CSS</h3><p>关键部分CSS可以这样来理解：它就是阻塞浏览器渲染出用户可识别的网页的一小部分CSS。我们注意网页的上半版版面。很明显，两个设备的版面的位置有很大的区别。因此我们做了一个大胆的猜测。</p>
<p>手动地检测这部分关键性的CSS是个很耗时的过程，尤其是样式、特性等不断改变时。这里有几个好的脚本，可以在你构建网页时，生成关键CSS。我们采用了Addy Osmani的版本。</p>
<h2 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h2><p>我们自己部署de Voorhoede网站，因为我们希望能够控制服务器环境。我们也想要尝试，是否可以通过改变服务器的配置来大大提升性能。当前我们使用了Apache服务和HTTPS协议。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>为了提升性能和安全性，我们研究了如何配置服务端。</p>
<p>我们使用H5BP apache样板配置，这个对改善Apache网络服务的性能和安全性是个很好的开始。他们也有其他服务器环境的配置。对于我们的大部分 HTML、CSS 和 JS，我们使用GZIP压缩。对于我们的所有网站资源，都使用缓存HTTP标头的做法。请阅读下面关于缓存的章节。</p>
<h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><p>用HTTPS来服务你的网站会对性能造成影响。这主要是设置了SSL握手，引入了大量潜在的东西。但通常情况下，我们可以做一些改变！</p>
<p>HTTP Strict Transport Security是一个HTTP标头，可以让服务器告诉浏览器只能用HTTPS来与它交互。这种方式防止HTTP请求被重定向为HTTPS。所有尝试用HTTP来访问站点的请求都会被自动转换成HTTPS。它可以来回的服务我们的网站。</p>
<p>TLS false start允许客户端在第一个TLS回合结束后，马上开始向后端发送加密的数据。这种优化为给一个回合新建一个TLS连接减少了握手。一旦客户端知道了密钥，就可以开始传输应用数据。剩下的握手用来确认是否有人篡改握手记录，并且可以并行处理。</p>
<p>TLS session resumption通过确认浏览器和服务器是否已经通过TLS取得联系来帮我们节省另一个来回。浏览器会记住这一次的标识符，下次发起连接时，这个标识符就会被重用，节省了一个来回。</p>
<h2 id="cookies的使用"><a href="#cookies的使用" class="headerlink" title="cookies的使用"></a>cookies的使用</h2><p>我们没有用一门服务端的语言，只有静态的Apache网络服务。但一个Apache网络服务仍可以做包括SSI在内的后端服务，并且读取cookies。通过巧用cookies和运行那部分被Apache改写的HTML，我们可以大大提升前端性能。下面这个例子就是。<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&lt;!-- #if expr="($HTTP_COOKIE!=/css-loaded/) || ($HTTP_COOKIE=/.css-loaded=([^;]+);?.*/&amp;&amp; $&#123;1&#125; != 0d82f.css)" --&gt;</div><div class="line">&lt;noscript&gt;&lt;link rel="stylesheet" href="0d82f.css"&gt;&lt;/noscript&gt;</div><div class="line">&lt;script&gt;</div><div class="line">  (function()&#123;</div><div class="line">    function loadCSS(url)&#123;&#125;</div><div class="line">    function onloadCss(stylesheet,callback)&#123;&#125;</div><div class="line">    function setCookie(name, value, expInDays)&#123;&#125;</div><div class="line"></div><div class="line">    var stylesheet = loadCSS('0d82f.css');</div><div class="line">    onloadCss(stylesheet, function()&#123;</div><div class="line">      setCookie('css-loaded', '0d82f', 100);</div><div class="line">    &#125;)</div><div class="line">  &#125;)()</div><div class="line">&lt;/script&gt;</div><div class="line"></div><div class="line">&lt;style&gt;/*critical CSS here*/&lt;/styles&gt;</div><div class="line"></div><div class="line">&lt;link rel="stylesheet" href="0d82f.css"&gt;</div></pre></td></tr></table></figure></p>
<p>The Apache server side logic are the comment looking lines starting with Apache 服务端逻辑是一些看起来一行一行的评论，一般这样开始：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;!-- #. Let&apos;s look at this step by step: $HTTP_COOKIE!=/css-loaded/ checks if no CSS cache cookie exists yet. $HTTP_COOKIE=/.css-loaded=([^;]+);?./ &amp;&amp; $&#123;1&#125; != &apos;0d82f.css&apos; checks if the cached CSS version is not the current version.</div></pre></td></tr></table></figure></p>
<p>If <!-- #if expr="..." --> 如果是true的话，我们就假定这是用户的第一次浏览。</p>
<p>第一次浏览我们添加了 <noscript> 标签，里面放置了 <link rel="stylesheet">。之所以这样做，是因为我们要异步加载整份CSS和JS。如果JS不能用的话，这种做法是不能执行的。这意味着，我们要用常规的加载CSS的方法来做回退。</noscript></p>
<p>我们添加了一个行内的脚本来懒加载CSS，onloadCSS 回调里面可以设置cookies.</p>
<p>在同一份脚本里面，我们异步加载了整份CSS。</p>
<p>在 onloadCSS的回调里面，我们用版本号来设置cookie的值。</p>
<p>在这个脚本后面，我们添加了一行关键CSS的样式。这个会阻塞渲染，但时间是非常短的，而且可以避免页面展示出来只有纯粹的HTML而没有样式的情况。</p>
<p><!-- #else --> 声明（意味着 css-loaded 的cookie 已经存在）用户重复浏览。因为我们可以从某种程度上来假定，CSS文件之前已经被加载过了，我们可以利用浏览器缓存来提供样式表。这样从缓存里面加载速度就很快了。同样的方法也被用来在第一次异步加载字体，后续的重复浏览也是从缓存里面获取字体。</p>
<h2 id="文件级缓存"><a href="#文件级缓存" class="headerlink" title="文件级缓存"></a>文件级缓存</h2><p>由于我们在重现页面时很大程度上依赖于浏览器缓存，所以我们需要确认我们的缓存是否合理。理想中我们是要永远的存储资源（CSS、js、 字体、图片），只有当这些文件被修改时才需要更新。当请求的URL是唯一时，缓存就会失效。每更新一个版本，我们都会用 git tag 打个标签。所以最简单的方式就是给我们请求的URL加上一个参数（代码版本号），如 <a href="https://www.voorhoede.nl/assets/css/main-8af99277a6.css?v=1.0.4.。" target="_blank" rel="external">https://www.voorhoede.nl/assets/css/main-8af99277a6.css?v=1.0.4.。</a></p>
<p>但是，这种做法的缺点就是当我们要写一个新的博客post（这也是我们代码库的一部分，并没有永久地存储在CMS），原来缓存的资源将会失效，尽管没有改变原来那些资源。</p>
<p>就在我们尝试去改善这种方法时，我们发现了 gulp-rev 和 gulp-rev-replace 。这些脚本会自动合理地在我们的文件名称后面添加一窜hash值。这意味着只有实际上文件被改变时，才会去改变请求的URL，这样每个文件的缓存就会自动失效。</p>
<h2 id="成果"><a href="#成果" class="headerlink" title="成果"></a>成果</h2><p>如果你看到这里，你应该是想要知道成果的。测试网页的性能可以采用像 PageSpeed Insights 这样的工具，它有很实用的提示。也可以使用 WebPagetest来测试，有扩展性的网络分析。我认为测试网页渲染性能的最好方法就是在疯狂地遏制网络通信时来观察网页的进程。这意味着，用一种不切实际的方法来遏制通信。在谷歌浏览器，你可以这样操作 (via the inspector &gt; Network tab) 来限制通信，观察网页形成过程中，请求是如何缓慢加载的。</p>
<p>下面是我们的网页在 50KB/s 的情况下的加载状况。<br>这是 de Voorhoede site 首屏的网络分析，是网页第一次进程的一个概览。</p>
<p>注意到在50KB/s的网速中，我们是如何让首屏的渲染只用了 2.27 秒的。也就是第一张幻灯片和瀑布图里面的黄色线所代表的位置。黄线恰好绘在就是HTML已经加载完的时间位置。HTML包含了关键CSS，保证页面的可观性。所有其他的CSS都是用懒加载，所以我们可以等到全部资源加载完时才与页面进行交互。这也是我们想要的效果！</p>
<p>另一个值得注意的就是自定义字体从来不在这缓慢的链接上加载。 font face 观察器会自动注意到这一点。但是，如果我们不异步加载字体，你注视大多数浏览器，都会出现 FOIT(不可见文本的闪现，上文有提及)的情况。</p>
<p>所有的CSS文件仅在8s后就都加载完毕。相反，如果我们不采用加载关键CSS的方式，而是采用加载全部CSS，我们在前8秒看到的将会是空白的页面。</p>
<p>如果你感到好奇，想与那些不太注重性能的网站对比一下加载时间，那赶紧试试吧。那个时间肯定是飞涨啊！</p>
<p>用上面介绍的工具测试了我们的网站，结果也是让人满意的。 PageSpeed insights 在移动性能方面给了我们100分，多么了不起啊！</p>
<p>PageSpeed insights 对 voorhoede.nl的测试结果! 速度100分！g</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/08/18/JavaScript设计模式二/" itemprop="url">
                  JavaScript设计模式二
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-08-18T14:06:04+08:00" content="2016-08-18">
              2016-08-18
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/笔记/" itemprop="url" rel="index">
                    <span itemprop="name">笔记</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/08/18/JavaScript设计模式二/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/08/18/JavaScript设计模式二/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>Comedy is acting out optimism.</p>
</blockquote>
<h2 id="中介者模式"><a href="#中介者模式" class="headerlink" title="中介者模式"></a>中介者模式</h2><p>字典中中介者的定义是，一个中立方，在谈判和冲突解决过程中起辅助作用。在我们的世界，一个中介者是一个行为设计模式，使我们可以导出统一的接口，这样系统不同部分就可以彼此通信。</p>
<p>如果系统组件之间存在大量的直接关系，就可能是时候，使用一个中心的控制点，来让不同的组件通过它来通信。中介者通过将组件之间显示的直接的引用替换成通过中心点来交互的方式，做到松耦合。这样可以帮助我们解耦和改善组件的重用性。</p>
<p>在现实世界中，类似的系统就是，飞行控制系统。一个航站塔(中介者)处理哪个飞机可以起飞，哪个可以着陆，因为所有的通信(监听的通知或者广播的通知)都是飞机和控制塔之间进行的，而不是飞机和飞机之间进行的额。一个中央集权的控制中心是这个系统成功的关键，也正是中介者在软件设计领域中所扮演的角色。</p>
<p>从实现角度来讲，中介者模式是观察者模式中的共享被观察者对象。在这个系统中的对象之间直接的发布/订阅关系被牺牲掉了，取而代之的是维护一个通信的中心节点。</p>
<p>也可以认为是一种补充-用于应用级别的通知，例如不同子系统之间的通信，子系统本身很复杂，可能需要使用发布/订阅模式来做内部之间的解耦。</p>
<p>另外一个类似的例子是DOM的事件冒泡机制，以及事件代理机制。如果系统中所有的订阅者都是对文档订阅，而不是对独立的节点订阅，那么文档就充当一个中介者的角色。DOM的这种做法，不是将事件绑定到独立节点上，而是用一个更高级别的对象负责通知订阅者关于交互事件的信息。</p>
<h3 id="基础的实现"><a href="#基础的实现" class="headerlink" title="基础的实现"></a>基础的实现</h3><p>中介者模式的一种简单的实现可以在下面找到，publish()和subscribe()犯法都被暴露出来使用：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> mediator = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"></div><div class="line">  <span class="comment">// Storage for topics that can be broadcast or listened to</span></div><div class="line">  <span class="keyword">var</span> topics = &#123;&#125;;</div><div class="line"></div><div class="line">  <span class="comment">// Subscribe to a topic, supply a callback to be executed</span></div><div class="line">  <span class="comment">// when that topic is broadcast to</span></div><div class="line">  <span class="keyword">var</span> subscribe = <span class="function"><span class="keyword">function</span>(<span class="params"> topic, fn </span>)</span>&#123;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> ( !topics[topic] )&#123;</div><div class="line">        topics[topic] = [];</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      topics[topic].push( &#123; <span class="attr">context</span>: <span class="keyword">this</span>, <span class="attr">callback</span>: fn &#125; );</div><div class="line"></div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="comment">// Publish/broadcast an event to the rest of the application</span></div><div class="line">  <span class="keyword">var</span> publish = <span class="function"><span class="keyword">function</span>(<span class="params"> topic </span>)</span>&#123;</div><div class="line"></div><div class="line">      <span class="keyword">var</span> args;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> ( !topics[topic] )&#123;</div><div class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      args = <span class="built_in">Array</span>.prototype.slice.call( <span class="built_in">arguments</span>, <span class="number">1</span> );</div><div class="line">      <span class="keyword">for</span> ( <span class="keyword">var</span> i = <span class="number">0</span>, l = topics[topic].length; i &lt; l; i++ ) &#123;</div><div class="line"></div><div class="line">          <span class="keyword">var</span> subscription = topics[topic][i];</div><div class="line">          subscription.callback.apply( subscription.context, args );</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>;</div><div class="line">  &#125;;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> &#123;</div><div class="line">      <span class="attr">publish</span>: publish,</div><div class="line">      <span class="attr">subscribe</span>: subscribe,</div><div class="line">      <span class="attr">installTo</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> obj </span>)</span>&#123;</div><div class="line">          obj.subscribe = subscribe;</div><div class="line">          obj.publish = publish;</div><div class="line">      &#125;</div><div class="line">  &#125;;</div><div class="line">&#125;());</div></pre></td></tr></table></figure></p>
<h3 id="高级的实现"><a href="#高级的实现" class="headerlink" title="高级的实现"></a>高级的实现</h3><p>更高级的实现方式，首先，让我们实现认购的概念，我们可以考虑一个中介者主题的注册。<br>通过生成对象实体，我们稍后能够简单的更新认购，而不需要去取消注册然后重新注册它们。认购可以写成一个使用被称作一个选项对象或者一个上下文环境的函数。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Pass in a context to attach our Mediator to.</span></div><div class="line"><span class="comment">//By default this will be the window object</span></div><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params">root</span>)</span>&#123;</div><div class="line">  <span class="function"><span class="keyword">function</span> <span class="title">guidGenerator</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="comment">//Our Subscriber constructor</span></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Subscriber</span>(<span class="params">fn, options, context</span>)</span>&#123;</div><div class="line">      <span class="keyword">if</span>(!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Subscriber))&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Subscriber(fn, context, options);</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line"></div><div class="line">        <span class="comment">//guidGenerator() is a function that generates</span></div><div class="line">        <span class="comment">//GUIDs for instances of our Mediators Subscribers so we can easily reference them later on. We're going to skip its implementation for brevity</span></div><div class="line"></div><div class="line">        <span class="keyword">this</span>.id = guidGenerator();</div><div class="line">        <span class="keyword">this</span>.fn = fn;</div><div class="line">        <span class="keyword">this</span>.options = options;</div><div class="line">        <span class="keyword">this</span>.context = context;</div><div class="line">        <span class="keyword">this</span>.topic = <span class="literal">null</span>;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;)();</div></pre></td></tr></table></figure></p>
<p>在我们的中介者模式中包含了一长串的回调和子主题，当中间人发布在我们中间人实体上被调用的时候被启动。它也包含操作数据列表方法。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//Let's model the topic</span></div><div class="line"><span class="comment">//JavaScript lets us use a Function object as a conjunction of a prototype for use with the new object and a constructor function to be invoked.</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Topic</span>(<span class="params">namespace</span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>(!(<span class="keyword">this</span> <span class="keyword">instanceof</span> Topic))&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Topic(namespace);</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    <span class="keyword">this</span>.namespace = namespace || <span class="string">""</span>;</div><div class="line">    <span class="keyword">this</span>._callbacks = [];</div><div class="line">    <span class="keyword">this</span>._topics = [];</div><div class="line">    <span class="keyword">this</span>.stopped = <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">//Define the prototype for our topic, including ways to add new subscribers or retrieve existing ones.</span></div><div class="line">Topic.prototype = &#123;</div><div class="line">  <span class="comment">//Add a new subscriber</span></div><div class="line">  AddSubscriber: <span class="function"><span class="keyword">function</span>(<span class="params">fn,options,context</span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> callback = <span class="keyword">new</span> Subscriber(fn, options, context);</div><div class="line">    <span class="keyword">this</span>._callbacks.push(callback);</div><div class="line">    callback.topic = <span class="keyword">this</span>;</div><div class="line">    <span class="keyword">return</span> callback;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们的主题实体被当做中间人调用的一个参数被传递。使用一个方便实用的calledStopPropagation()方法，回调就可以进一步被传播开来：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">StopPropagation: <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.stopped: <span class="literal">true</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们也能够使得当提供一个GUID的标识符的时候检索订购用户更加容易:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">GetSubscriber: <span class="function"><span class="keyword">function</span>(<span class="params">identifier</span>)</span>&#123;</div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> x=<span class="number">0</span>,y=<span class="keyword">this</span>._callbacks.length; x&lt;y ; x++)&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>._callbacks[x].id == identifier || <span class="keyword">this</span>._callbacks[x].fn == identifier)&#123;</div><div class="line">      <span class="keyword">return</span> <span class="keyword">this</span>._callbacks[x];</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span>(<span class="keyword">var</span> z <span class="keyword">in</span> <span class="keyword">this</span>._topics)&#123;</div><div class="line">    <span class="keyword">if</span>(<span class="keyword">this</span>._topics.hasOwnProperty(z))&#123;</div><div class="line">      <span class="keyword">var</span> sub = <span class="keyword">this</span>._topics[z].GetSubscriber(identifier);</div><div class="line">      <span class="keyword">if</span>(sub !== <span class="literal">undefined</span>)(</div><div class="line">        <span class="keyword">return</span> sub;</div><div class="line">      )</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着，在我们需要它们的情况下，我们也能够提供添加新主题，检查现有的主题或者检索主题的简单方法：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">AddTopic: <span class="function"><span class="keyword">function</span>(<span class="params"> topic </span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>._topics[topic] = <span class="keyword">new</span> Topic( (<span class="keyword">this</span>.namespace ? <span class="keyword">this</span>.namespace + <span class="string">":"</span> : <span class="string">""</span>) + topic );</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="attr">HasTopic</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> topic </span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._topics.hasOwnProperty( topic );</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="attr">ReturnTopic</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> topic </span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._topics[topic];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果我们觉得不再需要它们了,我们也可以明确的删除这些订购用户.下面就是通过它的其子主题递归删除订购用户的代码:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">RemoveSubscriber: <span class="function"><span class="keyword">function</span>(<span class="params"> identifier </span>)</span>&#123;</div><div class="line">  <span class="keyword">if</span>( !identifier )&#123;</div><div class="line">    <span class="keyword">this</span>._callbacks = [];</div><div class="line"></div><div class="line">    <span class="keyword">for</span>( <span class="keyword">var</span> z <span class="keyword">in</span> <span class="keyword">this</span>._topics )&#123;</div><div class="line">      <span class="keyword">if</span>( <span class="keyword">this</span>._topics.hasOwnProperty(z) )&#123;</div><div class="line">        <span class="keyword">this</span>._topics[z].RemoveSubscriber( identifier );</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">for</span>( <span class="keyword">var</span> y = <span class="number">0</span>, x = <span class="keyword">this</span>._callbacks.length; y &lt; x; y++ ) &#123;</div><div class="line">    <span class="keyword">if</span>( <span class="keyword">this</span>._callbacks[y].fn == identifier || <span class="keyword">this</span>._callbacks[y].id == identifier )&#123;</div><div class="line">      <span class="keyword">this</span>._callbacks[y].topic = <span class="literal">null</span>;</div><div class="line">      <span class="keyword">this</span>._callbacks.splice( y,<span class="number">1</span> );</div><div class="line">      x--; y--;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>接着我们通过递归子主题将发布任意参数的能够包含到订购服务对象中:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Publish: <span class="function"><span class="keyword">function</span>(<span class="params"> data </span>)</span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">for</span>( <span class="keyword">var</span> y = <span class="number">0</span>, x = <span class="keyword">this</span>._callbacks.length; y &lt; x; y++ ) &#123;</div><div class="line"></div><div class="line">        <span class="keyword">var</span> callback = <span class="keyword">this</span>._callbacks[y], l;</div><div class="line">          callback.fn.apply( callback.context, data );</div><div class="line"></div><div class="line">      l = <span class="keyword">this</span>._callbacks.length;</div><div class="line"></div><div class="line">      <span class="keyword">if</span>( l &lt; x )&#123;</div><div class="line">        y--;</div><div class="line">        x = l;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">for</span>( <span class="keyword">var</span> x <span class="keyword">in</span> <span class="keyword">this</span>._topics )&#123;</div><div class="line">      <span class="keyword">if</span>( !<span class="keyword">this</span>.stopped )&#123;</div><div class="line">        <span class="keyword">if</span>( <span class="keyword">this</span>._topics.hasOwnProperty( x ) )&#123;</div><div class="line">          <span class="keyword">this</span>._topics[x].Publish( data );</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.stopped = <span class="literal">false</span>;</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>接着我们暴露我们将主要交互的调节实体.这里它是通过注册的并且从主题中删除的事件来实现的<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">Mediator</span>(<span class="params"></span>) </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">if</span> ( !(<span class="keyword">this</span> <span class="keyword">instanceof</span> Mediator) ) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Mediator();</div><div class="line">  &#125;<span class="keyword">else</span>&#123;</div><div class="line">    <span class="keyword">this</span>._topics = <span class="keyword">new</span> Topic( <span class="string">""</span> );</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>想要更多先进的用例,我们可以看看调解支持的主题命名空间,下面这样的asinbox:messages:new:read.GetTopic 返回基于一个命名空间的主题实体。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">Mediator.prototype = &#123;</div><div class="line"></div><div class="line">  <span class="attr">GetTopic</span>: <span class="function"><span class="keyword">function</span>(<span class="params"> namespace </span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> topic = <span class="keyword">this</span>._topics,</div><div class="line">        namespaceHierarchy = namespace.split( <span class="string">":"</span> );</div><div class="line"></div><div class="line">    <span class="keyword">if</span>( namespace === <span class="string">""</span> )&#123;</div><div class="line">      <span class="keyword">return</span> topic;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span>( namespaceHierarchy.length &gt; <span class="number">0</span> )&#123;</div><div class="line">      <span class="keyword">for</span>( <span class="keyword">var</span> i = <span class="number">0</span>, j = namespaceHierarchy.length; i &lt; j; i++ )&#123;</div><div class="line"></div><div class="line">        <span class="keyword">if</span>( !topic.HasTopic( namespaceHierarchy[i]) )&#123;</div><div class="line">          topic.AddTopic( namespaceHierarchy[i] );</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        topic = topic.ReturnTopic( namespaceHierarchy[i] );</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">return</span> topic;</div><div class="line">  &#125;,</div></pre></td></tr></table></figure></p>
<p>这一节我们定义了一个Mediator.Subscribe方法，它接受一个主题命名空间,一个将要被执行的函数,选项和又一个在订阅中调用函数的上下文环境.这样就创建了一个主题,如果这样的一个主题存在的话<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Subscribe: <span class="function"><span class="keyword">function</span>(<span class="params"> topiclName, fn, options, context </span>)</span>&#123;</div><div class="line">  <span class="keyword">var</span> options = options || &#123;&#125;,</div><div class="line">      context = context || &#123;&#125;,</div><div class="line">      topic = <span class="keyword">this</span>.GetTopic( topicName ),</div><div class="line">      sub = topic.AddSubscriber( fn, options, context );</div><div class="line"></div><div class="line">  <span class="keyword">return</span> sub;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>根据这一点,我们可以进一步定义能够访问特定订阅用户,或者将他们从主题中递归删除的工具<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Returns a subscriber for a given subscriber id / named function and topic namespace</span></div><div class="line"></div><div class="line">GetSubscriber: <span class="function"><span class="keyword">function</span>(<span class="params"> identifier, topic </span>)</span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.GetTopic( topic || <span class="string">""</span> ).GetSubscriber( identifier );</div><div class="line">&#125;,</div><div class="line"></div><div class="line"><span class="comment">// Remove a subscriber from a given topic namespace recursively based on</span></div><div class="line"><span class="comment">// a provided subscriber id or named function.</span></div><div class="line"></div><div class="line">Remove: <span class="function"><span class="keyword">function</span>(<span class="params"> topicName, identifier </span>)</span>&#123;</div><div class="line">  <span class="keyword">this</span>.GetTopic( topicName ).RemoveSubscriber( identifier );</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>我们主要的发布方式可以让我们随意发布数据到选定的主题命名空间，这可以在下面的代码中看到。</p>
<p>主题可以被向下递归.例如,一条对inbox:message的post将发送到inbox:message:new和inbox:message:new:read.它将像接下来这样被使用:Mediator.Publish( “inbox:messages:new”, [args] );<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Publish: <span class="function"><span class="keyword">function</span>(<span class="params"> topicName </span>)</span>&#123;</div><div class="line">    <span class="keyword">var</span> args = <span class="built_in">Array</span>.prototype.slice.call( <span class="built_in">arguments</span>, <span class="number">1</span>),</div><div class="line">        topic = <span class="keyword">this</span>.GetTopic( topicName );</div><div class="line"></div><div class="line">    args.push( topic );</div><div class="line"></div><div class="line">    <span class="keyword">this</span>.GetTopic( topicName ).Publish( args );</div><div class="line">  &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure></p>
<p>最后，我们可以很容易的暴露我们的中间人，将它附着在传递到根中的对象上：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root.Mediator = Mediator;</div><div class="line">  Mediator.Topic = Topic;</div><div class="line">  Mediator.Subscriber = Subscriber;</div><div class="line"></div><div class="line">  <span class="comment">// Remember we can pass anything in here. I've passed inwindowto</span></div><div class="line">  <span class="comment">// attach the Mediator to, but we can just as easily attach it to another</span></div><div class="line">  <span class="comment">// object if desired.</span></div><div class="line">&#125;)( <span class="built_in">window</span> );</div></pre></td></tr></table></figure></p>
<h3 id="优点-amp-缺点"><a href="#优点-amp-缺点" class="headerlink" title="优点&amp;缺点"></a>优点&amp;缺点</h3><p>中间人模式最大的好处就是，它节约了对象或者组件之间的通信信道，这些对象或者组件存在于从多对多到多对一的系统之中。由于解耦合水平的因素，添加新的发布或者订阅者是相对容易的。</p>
<p>也许使用这个模式最大的缺点是它可以引入一个单点故障。在模块之间放置一个中间人也可能会造成性能损失，因为它们经常是间接地的进行通信的。由于松耦合的特性，仅仅盯着广播很难去确认系统是如何做出反应的。</p>
<p>这就是说，提醒我们自己解耦合的系统拥有许多其它的好处，是很有用的——如果我们的模块互相之间直接的进行通信，对于模块的改变（例如：另一个模块抛出了异常）可以很容易的对我们系统的其它部分产生多米诺连锁效应。这个问题在解耦合的系统中很少需要被考虑到。</p>
<p>在一天结束的时候，紧耦合会导致各种头痛，这仅仅只是另外一种可选的解决方案，但是如果得到正确实现的话也能够工作得很好。</p>
<h3 id="中间人Vs观察者"><a href="#中间人Vs观察者" class="headerlink" title="中间人Vs观察者"></a>中间人Vs观察者</h3><p>中间人模式最大的好处就是，它节约了对象或者组件之间的通信信道，这些对象或者组件存在于从多对多到多对一的系统之中。由于解耦合水平的因素，添加新的发布或者订阅者是相对容易的。</p>
<p>也许使用这个模式最大的缺点是它可以引入一个单点故障。在模块之间放置一个中间人也可能会造成性能损失，因为它们经常是间接地的进行通信的。由于松耦合的特性，仅仅盯着广播很难去确认系统是如何做出反应的。</p>
<p>这就是说，提醒我们自己解耦合的系统拥有许多其它的好处，是很有用的——如果我们的模块互相之间直接的进行通信，对于模块的改变（例如：另一个模块抛出了异常）可以很容易的对我们系统的其它部分产生多米诺连锁效应。这个问题在解耦合的系统中很少需要被考虑到。</p>
<p>在一天结束的时候，紧耦合会导致各种头痛，这仅仅只是另外一种可选的解决方案，但是如果得到正确实现的话也能够工作得很好。</p>
<h3 id="中间人Vs门面"><a href="#中间人Vs门面" class="headerlink" title="中间人Vs门面"></a>中间人Vs门面</h3><p>不久我们的描述就将涵盖门面模式，但作为参考之用，一些开发者也想知道中间人和门面模式之间有哪些相似之处。它们都对模块的功能进行抽象，但有一些细微的差别。</p>
<p>中间人模式让模块之间集中进行通信，它会被这些模块明确的引用。门面模式却只是为模块或者系统定义一个更加简单的接口，但不添加任何额外的功能。系统中其他的模块并不直接意识到门面的概念，而可以被认为是单向的。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="GaoQ" />
          <p class="site-author-name" itemprop="name">GaoQ</p>
          <p class="site-description motion-element" itemprop="description">There are no shortcuts to any place worth going</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">40</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              
                <span class="site-state-item-count">5</span>
                <span class="site-state-item-name">分类</span>
              
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">28</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        <div class="links-of-blogroll motion-element">
          
        </div>

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">GaoQ</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>



      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  


  




<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>

  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=0.5.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=0.5.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=0.5.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"gaoquan"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  
  <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
      tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
      }
    });
  </script>

  <script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
      var all = MathJax.Hub.getAllJax(), i;
      for (i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';
      }
    });
  </script>

  
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/MathJax.js"></script>
    <script type="text/javascript" src="http://cdn.staticfile.org/mathjax/2.4.0/config/TeX-AMS-MML_HTMLorMML.js"></script>
  


  


</body>
</html>
